<!DOCTYPE html>
<html>

<head>
  <base target="_top">
  <meta charset="utf-8">
  <meta name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
  <title>çµŒè²»ç²¾ç®— Pro</title>
  <style>
    /* ========== ãƒ™ãƒ¼ã‚¹è¨­å®š ========== */
    :root {
      --primary: #2563eb;
      --primary-dark: #1d4ed8;
      --accent: #f59e0b;
      --bg: #f8fafc;
      --text: #0f172a;
      --sub-text: #64748b;
      --border: #e2e8f0;
      /* ã‚»ãƒ¼ãƒ•ã‚¨ãƒªã‚¢ã®åˆæœŸå€¤ï¼ˆæœªå¯¾å¿œãƒ–ãƒ©ã‚¦ã‚¶ç”¨ï¼‰ */
      --safe-top: 20px;
      --safe-bottom: 20px;
      --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.1);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    }

    /* iPhoneç­‰ã®ã‚»ãƒ¼ãƒ•ã‚¨ãƒªã‚¢å–å¾— */
    @supports (padding-top: env(safe-area-inset-top)) {
      :root {
        --safe-top: env(safe-area-inset-top);
        --safe-bottom: env(safe-area-inset-bottom);
      }
    }

    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
      outline: none;
    }

    html {
      height: 100%;
      overflow: hidden;
      /* Default: fixed viewport for App mode */
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100dvh;
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 50%, #e2e8f0 100%);
      color: var(--text);
      font-size: 18px;
      overflow: hidden;
      /* Default: internal scroll */
    }

    /* ã‚¢ãƒ—ãƒªå…¨ä½“ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
    .app-root {
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      padding-top: var(--safe-top);
      /* padding-bottomã¯å€‹åˆ¥ã®ãƒ“ãƒ¥ãƒ¼ã§åˆ¶å¾¡ã™ã‚‹ãŸã‚å‰Šé™¤ */
    }

    .view-section {
      flex: 1;
      display: none;
      flex-direction: column;
      overflow: hidden;
      /* Default: internal scroll */
      height: 100%;
      /* Default: fill viewport */
      position: relative;
    }

    /* Admin View: Allow auto height for global scroll */
    #adminView.view-section {
      height: auto;
      overflow: visible;
    }

    .view-section.active {
      display: flex;
    }

    /* ========== ãƒ˜ãƒƒãƒ€ãƒ¼ ========== */
    header {
      flex: 0 0 auto;
      position: sticky;
      top: 0;
      height: 80px;
      padding: 0 24px;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(248, 250, 252, 0.95));
      backdrop-filter: blur(20px);
      border-bottom: 1px solid rgba(226, 232, 240, 0.6);
      display: flex;
      align-items: center;
      gap: 20px;
      z-index: 20;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
    }

    h1 {
      margin: 0;
      font-size: 1.7rem;
      font-weight: 800;
      background: linear-gradient(135deg, #2563eb, #3b82f6);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      white-space: nowrap;
      letter-spacing: -0.01em;
    }

    #applicantSelector {
      flex: 1;
      min-width: 0;
      height: 52px;
      padding: 0 20px;
      border-radius: 14px;
      border: 1px solid rgba(226, 232, 240, 0.8);
      font-size: 1.2rem;
      font-weight: 600;
      background: linear-gradient(135deg, rgba(241, 245, 249, 0.9), rgba(255, 255, 255, 0.9));
      color: var(--text);
      backdrop-filter: blur(8px);
      appearance: none;
      -webkit-appearance: none;
      background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23007CB2%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
      background-repeat: no-repeat;
      background-position: right 20px top 50%;
      background-size: 16px;
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.06);
      transition: all 0.2s;
    }

    #applicantSelector:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .help-btn {
      width: 48px;
      height: 48px;
      background: linear-gradient(135deg, #06b6d4, #0891b2);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 1.3rem;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(6, 182, 212, 0.3);
      transition: all 0.2s;
    }

    .help-btn:active {
      transform: scale(0.95);
    }

    .admin-switch-btn {
      padding: 14px 20px;
      background: linear-gradient(135deg, #475569, #334155);
      color: white;
      border: none;
      border-radius: 14px;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      display: none;
      box-shadow: 0 3px 10px rgba(71, 85, 105, 0.3);
      transition: all 0.2s;
      min-height: 52px;
    }

    .admin-switch-btn:active {
      transform: scale(0.95);
    }

    /* ========== ãƒ¦ãƒ¼ã‚¶ãƒ¼ç”»é¢ ========== */
    .user-main {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: #f1f5f9;
      position: relative;
      /* ãƒ•ãƒƒã‚¿ãƒ¼ãŒé‡ãªã‚‰ãªã„ã‚ˆã†ã«ä¸‹éƒ¨ã«ä½™ç™½ã‚’æŒãŸã›ã‚‹ */
    }

    .cart-list {
      flex: 1;
      overflow-y: auto;
      padding: 20px 16px;
      /* ä¸‹éƒ¨ãƒ‰ãƒƒã‚¯ã®é«˜ã•(ç´„120px) + ã‚»ãƒ¼ãƒ•ã‚¨ãƒªã‚¢åˆ†ã®ä½™ç™½ */
      padding-bottom: calc(140px + var(--safe-bottom));
      display: flex;
      flex-direction: column;
      gap: 16px;
      -webkit-overflow-scrolling: touch;
    }

    .cart-empty {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 60%;
      color: var(--sub-text);
      gap: 2rem;
      text-align: center;
      padding: 2rem;
    }

    .cart-empty::before {
      content: "ğŸ“¸";
      font-size: 5rem;
      opacity: 0.7;
    }

    .cart-empty::after {
      content: "ãƒ¬ã‚·ãƒ¼ãƒˆã‚’æ’®å½±ã—ã¦\AçµŒè²»ç”³è«‹ã‚’å§‹ã‚ã¾ã—ã‚‡ã†";
      white-space: pre-line;
      font-size: 1.6rem;
      font-weight: 600;
      line-height: 1.6;
      color: #64748b;
    }

    /* ã‚«ãƒ¼ãƒ‰ãƒ‡ã‚¶ã‚¤ãƒ³ */
    .cart-item {
      background: white;
      border-radius: 20px;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 16px;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08), 0 1px 4px rgba(0, 0, 0, 0.04);
      transition: transform 0.1s, box-shadow 0.2s;
      border: 1px solid rgba(0, 0, 0, 0.04);
    }

    .cart-item:active {
      transform: scale(0.98);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.12), 0 2px 8px rgba(0, 0, 0, 0.06);
    }

    .cart-item-header {
      display: flex;
      align-items: flex-start;
      gap: 16px;
    }

    .cart-item-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .cart-item-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-top: 12px;
      border-top: 1px solid #f1f5f9;
    }

    .cart-thumb-box {
      width: 80px;
      height: 80px;
      border-radius: 16px;
      overflow: hidden;
      background: #f1f5f9;
      position: relative;
      flex-shrink: 0;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .cart-thumb {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .cart-info {
      overflow: hidden;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .cart-meta {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 1rem;
      color: var(--sub-text);
      margin-bottom: 4px;
    }

    .status-badge {
      padding: 8px 14px;
      border-radius: 12px;
      background: linear-gradient(135deg, #e0f2fe, #bae6fd);
      color: var(--primary);
      font-weight: 700;
      white-space: nowrap;
      font-size: 1rem;
      box-shadow: 0 1px 3px rgba(37, 99, 235, 0.2);
    }

    .cart-vendor {
      font-weight: 700;
      font-size: 1.3rem;
      color: #1e293b;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      line-height: 1.3;
    }

    .cart-amount {
      font-size: 1.8rem;
      font-weight: 900;
      color: #059669;
      text-align: right;
      letter-spacing: -0.02em;
    }

    .cart-amount.zero {
      color: #cbd5e1;
      font-size: 1.5rem;
    }

    .cart-del-btn {
      padding: 14px 18px;
      background: #fef2f2;
      color: #dc2626;
      border: none;
      border-radius: 12px;
      font-weight: 600;
      font-size: 1.1rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.2s;
      min-height: 52px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .cart-del-btn:active {
      background: #fee2e2;
      transform: scale(0.95);
    }

    .analyzing-overlay {
      position: absolute;
      inset: 0;
      background: rgba(255, 255, 255, 0.8);
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .mini-spinner {
      width: 20px;
      height: 20px;
      border: 3px solid #ddd;
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    /* ========== ãƒ¦ãƒ¼ã‚¶ãƒ¼ç”»é¢ï¼šä¸‹éƒ¨æ“ä½œãƒ‰ãƒƒã‚¯ ========== */
    .operation-dock {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: linear-gradient(to top, rgba(255, 255, 255, 0.98), rgba(255, 255, 255, 0.95));
      backdrop-filter: blur(20px);
      padding: 20px 24px;
      padding-bottom: calc(24px + var(--safe-bottom));
      border-top-left-radius: 24px;
      border-top-right-radius: 24px;
      box-shadow: 0 -8px 32px rgba(0, 0, 0, 0.12), 0 -2px 8px rgba(0, 0, 0, 0.04);
      display: flex;
      flex-direction: column;
      gap: 16px;
      z-index: 50;
      border-top: 1px solid rgba(0, 0, 0, 0.06);
    }

    .dock-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .dock-bottom {
      display: flex;
      gap: 16px;
      align-items: center;
    }

    .total-block {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .total-label {
      font-size: 1.1rem;
      color: var(--sub-text);
      font-weight: 600;
      letter-spacing: 0.02em;
    }

    .total-price {
      font-size: 2.2rem;
      font-weight: 900;
      line-height: 1.1;
      color: #059669;
      letter-spacing: -0.02em;
    }

    .camera-launch-btn {
      width: 140px;
      height: 56px;
      border-radius: 28px;
      background: linear-gradient(135deg, #3b82f6, #1d4ed8);
      color: white;
      font-size: 1.8rem;
      font-weight: 600;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 8px;
      box-shadow: 0 8px 24px rgba(59, 130, 246, 0.4), 0 4px 12px rgba(59, 130, 246, 0.2);
      cursor: pointer;
      transition: all 0.2s;
      border: 3px solid rgba(255, 255, 255, 0.9);
      flex-shrink: 0;
    }

    .camera-launch-btn:active {
      transform: scale(0.95);
      box-shadow: 0 4px 16px rgba(59, 130, 246, 0.5);
    }

    .apply-btn {
      flex: 1;
      height: 60px;
      background: linear-gradient(135deg, #059669, #047857);
      color: white;
      border: none;
      border-radius: 16px;
      font-weight: 700;
      font-size: 1.3rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      box-shadow: 0 4px 16px rgba(5, 150, 105, 0.3), 0 2px 4px rgba(5, 150, 105, 0.2);
      transition: all 0.2s;
    }

    .apply-btn:disabled {
      background: #e2e8f0;
      color: #94a3b8;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .apply-btn:not(:disabled):active {
      background: linear-gradient(135deg, #047857, #065f46);
      transform: scale(0.98);
    }

    /* ========== ç®¡ç†è€…ç”»é¢ï¼ˆä¿®æ­£ç®‡æ‰€ï¼‰ ========== */
    .admin-main {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: #334155;
      overflow: hidden;
      /* ã‚³ãƒ³ãƒ†ãƒŠè‡ªä½“ã¯ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã•ã›ãªã„ */
      position: relative;
    }

    .admin-tools {
      flex: 0 0 auto;
      padding: 20px 24px;
      background: linear-gradient(135deg, #1e293b, #0f172a);
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid rgba(148, 163, 184, 0.2);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .tool-btn {
      font-size: 1rem;
      background: linear-gradient(135deg, #3b82f6, #2563eb);
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s;
      min-height: 44px;
      box-shadow: 0 3px 10px rgba(59, 130, 246, 0.3);
    }

    .tool-btn:active {
      transform: scale(0.95);
      background: linear-gradient(135deg, #2563eb, #1d4ed8);
    }

    .card-container {
      /* flex: 1; */
      width: 100%;
      /* overflow-y: auto; */
      /* overflow-x: hidden; */
      overflow: visible;
      padding: 24px;
      /* ãƒ•ãƒƒã‚¿ãƒ¼åˆ†ç¢ºä¿ */
      display: grid;
      /* PC: 2ã‚«ãƒ©ãƒ å›ºå®š */
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      align-content: start;
    }

    /* ãƒ¢ãƒã‚¤ãƒ«ãƒ»ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆã¯1ã‚«ãƒ©ãƒ  */
    @media (max-width: 900px) {
      .card-container {
        grid-template-columns: 1fr;
      }
    }


    .admin-card {
      width: 100%;
      /* Gridã«ãŠä»»ã› */
      max-width: none;
      height: auto;
      /* ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã«åˆã‚ã›ã¦é«˜ã•è‡ªå‹• */
      min-height: auto;
      scroll-snap-align: start;
      background: white;

      border-radius: 16px;
      /* ã‚¹ã‚¿ã‚¤ãƒªãƒƒã‚·ãƒ¥ãªå½± */
      box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1),
        0 8px 10px -6px rgba(0, 0, 0, 0.1);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      border: 1px solid rgba(226, 232, 240, 0.8);
      transition: transform 0.2s;
    }



    .ac-header {
      flex: 0 0 auto;
      padding: 20px;
      background: linear-gradient(135deg, #f8fafc, #f1f5f9);
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
    }

    .ac-user {
      font-size: 1.1rem;
      font-weight: 900;
      line-height: 1.3;
    }

    .ac-total {
      font-size: 1.5rem;
      font-weight: 900;
      color: var(--primary);
    }

    .ac-dept {
      font-size: 0.75rem;
      background: linear-gradient(135deg, #e0e7ff, #c7d2fe);
      padding: 4px 8px;
      border-radius: 6px;
      color: #3730a3;
      display: inline-block;
      margin-left: 6px;
      font-weight: 600;
    }

    .ac-body {
      /* flex: 1; */
      /* overflow-y: auto; */
      /* overflow-x: hidden; */
      overflow: visible;
      /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã•ã›ãšé«˜ã•ã‚’ä¼¸ã°ã™ */
      padding: 16px;
    }

    .detail-item {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 20px;
      border-bottom: 1px dashed #e2e8f0;
      padding-bottom: 16px;

      /* 2ã‚«ãƒ©ãƒ ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆç”¨ (å³å¯†) -> è¦–èªæ€§é‡è¦–ã§1ã‚«ãƒ©ãƒ ã«æˆ»ã™ãŒã€ã‚«ãƒ¼ãƒ‰è‡ªä½“ã®2åˆ—é…ç½®ã¯ç¶­æŒ */
      width: 100%;
      /* å¹…ãŒç¢ºä¿ã§ããªãã¦ã‚‚2åˆ—ã«ã™ã‚‹ãŸã‚ min-width ã‚’ä¸‹ã’ã‚‹ */
      min-width: 0;
      /* flex: 0 0 calc(50% - 6px); */
      flex: 1;
      box-sizing: border-box;
      border-radius: 8px;
      border: 1px solid #f1f5f9;
      padding: 12px;
      /* padding: 8px; */
      background: #f8fafc;
      /* é«˜ã•æƒãˆ */
      height: 100%;
    }

    .input-group-compact {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .input-group-compact label {
      flex: 0 0 70px;
      /* ãƒ©ãƒ™ãƒ«å¹…å›ºå®š */
      font-size: 0.75rem;
      font-weight: 600;
      color: #64748b;
      white-space: nowrap;
      text-align: right;
    }

    .d-row {
      display: flex;
      gap: 12px;
      width: 100%;
      box-sizing: border-box;
    }

    .d-thumb-box {
      width: 120px;
      /* PC: æ¨ªå¹…å›ºå®š */
      height: auto;
      min-height: 160px;
      background: #000;
      border-radius: 8px;
      overflow: hidden;
      flex-shrink: 0;
      align-self: stretch;
      /* é«˜ã•ã„ã£ã±ã„ã« */
    }

    .d-inputs {
      flex: 1;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 6px;
      /* é–“éš”èª¿æ•´ */
      min-width: 0;
    }

    /* 2åˆ—ã¾ãŸãç”¨ã‚¯ãƒ©ã‚¹ */
    .span-full {
      grid-column: 1 / -1;
    }

    input,
    select,
    textarea {
      width: 100%;
      padding: 6px 8px;
      /* ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ç¸®å° */
      border: 1px solid rgba(226, 232, 240, 0.6);
      border-radius: 6px;
      /* åŠå¾„ã‚‚å°‘ã—å°ã•ã */
      font-size: 0.85rem;
      /* æ–‡å­—ã‚µã‚¤ã‚ºç¸®å° */
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(248, 250, 252, 0.8));
      backdrop-filter: blur(8px);
      transition: all 0.2s;
      min-height: 32px;
      /* é«˜ã•ç¸®å° */
      box-sizing: border-box;
      color: var(--text);
    }

    textarea {
      font-family: inherit;
    }

    input:focus,
    select:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      background: rgba(255, 255, 255, 0.95);
    }

    select option {
      background: white;
      color: var(--text);
    }

    .ac-footer {
      flex: 0 0 auto;
      /* é«˜ã•ã‚’å›ºå®š */
      padding: 20px;
      border-top: 1px solid var(--border);
      display: flex;
      gap: 12px;
      background: linear-gradient(135deg, #fefefe, #f9fafb);
      /* ã‚«ãƒ¼ãƒ‰è‡ªä½“ãŒæµ®ã„ã¦ã„ã‚‹ãŸã‚ã€ã“ã“ã§ã®safe-bottomã¯ä¸è¦ */
    }

    .btn-ap {
      flex: 2;
      padding: 10px 16px;
      background: linear-gradient(135deg, #059669, #047857);
      color: white;
      border: none;
      border-radius: 12px;
      font-weight: 700;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.2s;
      min-height: 42px;
      box-shadow: 0 4px 16px rgba(5, 150, 105, 0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .btn-ap:active {
      transform: scale(0.98);
      background: linear-gradient(135deg, #047857, #065f46);
    }

    .btn-ap::before {
      content: 'âœ“';
      font-size: 1.2rem;
    }

    .btn-rj {
      flex: 1;
      padding: 10px 16px;
      background: linear-gradient(135deg, #fef2f2, #fee2e2);
      color: #dc2626;
      border: 1px solid rgba(239, 68, 68, 0.2);
      border-radius: 12px;
      font-weight: 700;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.2s;
      min-height: 42px;
      box-shadow: 0 3px 12px rgba(239, 68, 68, 0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .btn-rj:active {
      transform: scale(0.98);
      background: linear-gradient(135deg, #fee2e2, #fecaca);
    }

    .btn-rj::before {
      content: 'Ã—';
      font-size: 1.3rem;
    }

    .btn-rt {
      flex: 1.5;
      padding: 10px 16px;
      background: linear-gradient(135deg, #f59e0b, #ea580c);
      color: white;
      border: none;
      border-radius: 12px;
      font-weight: 700;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.2s;
      min-height: 42px;
      box-shadow: 0 4px 16px rgba(245, 158, 11, 0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .btn-rt:active {
      transform: scale(0.98);
      background: linear-gradient(135deg, #ea580c, #dc2626);
    }

    .btn-rt::before {
      content: 'â†©';
      font-size: 1.2rem;
    }

    /* ========== ãã®ä»–ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ç­‰ï¼‰ ========== */
    /* æ–°ã—ã„ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒªã‚¹ãƒˆã‚¹ã‚¿ã‚¤ãƒ« */
    .menu-list-item {
      width: 100%;
      display: flex;
      align-items: center;
      padding: 16px;
      border: none;
      background: white;
      border-bottom: 1px solid #f1f5f9;
      cursor: pointer;
      text-align: left;
      transition: background 0.2s;
    }

    .menu-list-item:last-child {
      border-bottom: none;
    }

    .menu-list-item:active {
      background: #f8fafc;
    }

    .ml-icon {
      font-size: 1.2rem;
      margin-right: 12px;
      width: 24px;
      text-align: center;
    }

    .ml-text {
      flex: 1;
      font-size: 1rem;
      font-weight: 600;
      color: #334155;
    }

    .ml-arrow {
      color: #cbd5e1;
      font-weight: bold;
    }

    .edit-modal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.4);
      z-index: 100;
      display: none;
      justify-content: center;
      align-items: flex-end;
      backdrop-filter: blur(8px);
    }

    .edit-sheet {
      width: 100%;
      max-width: 600px;
      background: linear-gradient(to bottom, rgba(255, 255, 255, 0.98), rgba(248, 250, 252, 0.95));
      backdrop-filter: blur(20px);
      border-radius: 24px 24px 0 0;
      padding: 24px;
      padding-bottom: calc(24px + var(--safe-bottom));
      display: flex;
      flex-direction: column;
      gap: 20px;
      animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1);
      max-height: 85vh;
      overflow-y: auto;
      border: 1px solid rgba(226, 232, 240, 0.3);
    }

    @keyframes slideUp {
      from {
        transform: translateY(100%);
      }

      to {
        transform: translateY(0);
      }
    }

    .sheet-handle {
      width: 40px;
      height: 5px;
      background: #cbd5e1;
      border-radius: 3px;
      margin: 0 auto 10px auto;
    }

    .edit-img-box {
      width: 100%;
      height: 200px;
      background: linear-gradient(135deg, #f8fafc, #f1f5f9);
      border-radius: 16px;
      display: flex;
      justify-content: center;
      align-items: center;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1), inset 0 1px 0 rgba(255, 255, 255, 0.5);
    }

    .edit-img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
    }

    .input-group label {
      display: block;
      font-size: 1.1rem;
      color: #374151;
      margin-bottom: 10px;
      font-weight: 600;
      letter-spacing: 0.01em;
    }

    .btn-save {
      padding: 20px;
      background: linear-gradient(135deg, #059669, #047857);
      color: white;
      border: none;
      border-radius: 16px;
      font-weight: 700;
      font-size: 1.4rem;
      margin-top: 16px;
      cursor: pointer;
      box-shadow: 0 6px 20px rgba(5, 150, 105, 0.3);
      transition: all 0.2s;
      min-height: 60px;
    }

    .btn-save:active {
      transform: scale(0.98);
      background: linear-gradient(135deg, #047857, #065f46);
    }

    .master-modal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 110;
      display: none;
      justify-content: center;
      align-items: center;
    }

    .master-box {
      width: 90%;
      max-width: 350px;
      background: white;
      border-radius: 16px;
      padding: 20px;
      max-height: 70vh;
      display: flex;
      flex-direction: column;
    }

    .master-list {
      flex: 1;
      overflow-y: auto;
      margin: 16px 0;
      border: 1px solid var(--border);
      border-radius: 8px;
    }

    .master-item {
      padding: 10px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
    }

    .help-modal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.6);
      z-index: 120;
      display: none;
      justify-content: center;
      align-items: center;
      backdrop-filter: blur(8px);
    }

    .help-content {
      width: 95%;
      max-width: 500px;
      max-height: 85vh;
      background: white;
      border-radius: 20px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
    }

    .help-header {
      padding: 24px 24px 16px;
      background: linear-gradient(135deg, #06b6d4, #0891b2);
      color: white;
      text-align: center;
    }

    .help-header h2 {
      margin: 0;
      font-size: 1.5rem;
      font-weight: 700;
    }

    .help-body {
      flex: 1;
      overflow-y: auto;
      padding: 0;
      -webkit-overflow-scrolling: touch;
    }

    .help-section {
      padding: 20px 24px;
      border-bottom: 1px solid #f1f5f9;
    }

    .help-section:last-child {
      border-bottom: none;
    }

    .help-section h3 {
      margin: 0 0 12px;
      font-size: 1.2rem;
      color: #0f172a;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .help-section p {
      margin: 0 0 8px;
      line-height: 1.6;
      color: #475569;
      font-size: 1rem;
    }

    .help-section ul {
      margin: 8px 0;
      padding-left: 20px;
      color: #475569;
      font-size: 1rem;
    }

    .help-section li {
      margin: 4px 0;
    }

    .help-footer {
      padding: 16px 24px;
      background: #f8fafc;
      border-top: 1px solid #e2e8f0;
      text-align: center;
    }

    #loadingOverlay {
      position: fixed;
      inset: 0;
      background: rgba(255, 255, 255, 0.9);
      z-index: 3000;
      display: none;
      justify-content: center;
      align-items: center;
      flex-direction: column;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #ddd;
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    #toast {
      position: fixed;
      bottom: 100px;
      left: 50%;
      transform: translateX(-50%) translateY(20px);
      background: #1e293b;
      color: white;
      padding: 10px 20px;
      border-radius: 50px;
      opacity: 0;
      transition: 0.3s;
      pointer-events: none;
      z-index: 2000;
      font-weight: bold;
      font-size: 0.9rem;
      box-shadow: var(--shadow-lg);
    }

    #toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }

    .confirm-toast {
      position: fixed;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      background: white;
      color: #1e293b;
      padding: 20px;
      border-radius: 20px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
      z-index: 1100;
      width: 90%;
      max-width: 340px;
      display: none;
      flex-direction: column;
      gap: 16px;
      animation: popUp 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    @keyframes popUp {
      from {
        transform: translateX(-50%) scale(0.8);
        opacity: 0;
      }

      to {
        transform: translateX(-50%) scale(1);
        opacity: 1;
      }
    }

    .confirm-actions {
      display: flex;
      gap: 10px;
    }

    .c-btn {
      flex: 1;
      padding: 18px;
      border: none;
      border-radius: 12px;
      font-weight: 700;
      font-size: 1.2rem;
      cursor: pointer;
      transition: all 0.2s;
      min-height: 52px;
    }

    .c-yes {
      background: linear-gradient(135deg, #3b82f6, #2563eb);
      color: white;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    .c-yes:active {
      background: linear-gradient(135deg, #2563eb, #1d4ed8);
      transform: scale(0.98);
    }

    .c-no {
      background: linear-gradient(135deg, #f1f5f9, #e2e8f0);
      color: #475569;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .c-no:active {
      background: linear-gradient(135deg, #e2e8f0, #cbd5e1);
      transform: scale(0.98);
    }

    #imageModal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.95);
      display: none;
      z-index: 999;
      justify-content: center;
      align-items: center;
    }

    #zoomImg {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
    }

    /* ========== é‡è¤‡è­¦å‘Šã‚¹ã‚¿ã‚¤ãƒ« ========== */
    .duplicate-warning {
      background: linear-gradient(135deg, #fef2f2, #fee2e2) !important;
      border: 2px solid #ef4444 !important;
      box-shadow: 0 4px 20px rgba(239, 68, 68, 0.3) !important;
      position: relative;
    }

    .duplicate-warning::before {
      content: "âš ï¸ é‡è¤‡ã®å¯èƒ½æ€§";
      position: absolute;
      top: 16px;
      left: 35%;
      transform: translateX(-50%);
      background: linear-gradient(135deg, #ef4444, #dc2626);
      color: white;
      padding: 6px 14px;
      border-radius: 14px;
      font-size: 0.8rem;
      font-weight: 700;
      box-shadow: 0 3px 12px rgba(239, 68, 68, 0.4);
      animation: pulseWarning 2s infinite;
      z-index: 10;
      white-space: nowrap;
    }

    @keyframes pulseWarning {

      0%,
      100% {
        transform: scale(1);
        opacity: 1;
      }

      50% {
        transform: scale(1.05);
        opacity: 0.8;
      }
    }

    .hidden {
      display: none;
    }

    /* ========== ãƒ•ãƒƒã‚¿ãƒ¼ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ ========== */
    .app-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: calc(60px + var(--safe-bottom));
      background: rgba(255, 255, 255, 0.98);
      backdrop-filter: blur(20px);
      border-top: 1px solid rgba(0, 0, 0, 0.06);
      display: flex;
      justify-content: space-around;
      padding-bottom: var(--safe-bottom);
      z-index: 900;
      box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.05);
    }

    .nav-btn {
      flex: 1;
      background: none;
      border: none;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 4px;
      color: #94a3b8;
      cursor: pointer;
      transition: all 0.2s;
    }

    .nav-btn.active {
      color: var(--primary);
    }

    .nav-icon {
      font-size: 1.5rem;
      transition: transform 0.2s;
    }

    .nav-btn.active .nav-icon {
      transform: scale(1.1);
    }

    .nav-text {
      font-size: 0.7rem;
      font-weight: 700;
      letter-spacing: 0.02em;
    }

    /* ãƒ¦ãƒ¼ã‚¶ãƒ¼ç”»é¢ã®èª¿æ•´ (ãƒ•ãƒƒã‚¿ãƒ¼åˆ†ç©ºã‘ã‚‹) */
    .cart-list {
      padding-bottom: calc(180px + var(--safe-bottom));
    }

    /* Dock + Nav */
    .operation-dock {
      bottom: calc(60px + var(--safe-bottom));
      /* Navã®ä¸Šã«é…ç½® */
      border-radius: 24px;
    }

    /* ========== ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç”»é¢ ========== */
    .menu-card {
      background: white;
      border: none;
      border-radius: 16px;
      padding: 12px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      transition: all 0.2s;
      cursor: pointer;
      aspect-ratio: 1/1;
    }

    .menu-card:active {
      transform: scale(0.96);
      background: #f8fafc;
    }

    .mc-icon {
      font-size: 1.8rem;
    }

    .mc-label {
      font-size: 0.8rem;
      font-weight: 700;
      color: #334155;
      word-break: break-all;
      line-height: 1.2;
      text-align: center;
    }

    .menu-card:active {
      transform: scale(0.96);
      background: #f8fafc;
    }

    .mc-icon {
      font-size: 2.5rem;
    }

    .mc-label {
      font-size: 0.95rem;
      font-weight: 700;
      color: #334155;
    }

    .menu-item {
      padding: 16px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #f1f5f9;
      cursor: pointer;
      color: #334155;
      font-weight: 600;
      transition: background 0.2s;
    }

    .menu-item:last-child {
      border-bottom: none;
    }

    .menu-item:active {
      background: #f8fafc;
    }

    /* ========== ãƒ¬ãƒãƒ¼ãƒˆç”»é¢ (å…±é€š) ========== */
    .score-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 24px;
    }

    .score-card {
      padding: 16px;
      border-radius: 16px;
      color: white;
      display: flex;
      flex-direction: column;
      gap: 4px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .sc-blue {
      background: linear-gradient(135deg, #3b82f6, #2563eb);
    }

    .sc-red {
      background: linear-gradient(135deg, #ef4444, #dc2626);
    }

    .sc-green {
      background: linear-gradient(135deg, #10b981, #059669);
    }

    .sc-orange {
      background: linear-gradient(135deg, #f59e0b, #d97706);
    }

    .sc-label {
      font-size: 0.8rem;
      font-weight: 600;
      opacity: 0.9;
    }

    .sc-val {
      font-size: 1.4rem;
      font-weight: 900;
      letter-spacing: -0.02em;
    }

    .report-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
      white-space: nowrap;
    }

    .report-table th,
    .report-table td {
      padding: 12px;
      text-align: right;
      border-bottom: 1px solid #e2e8f0;
    }

    .report-table th {
      text-align: center;
      background: #f8fafc;
      color: #64748b;
      font-weight: 600;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .report-table th:first-child,
    .report-table td:first-child {
      text-align: left;
      position: sticky;
      left: 0;
      background: white;
      z-index: 11;
      font-weight: bold;
      border-right: 1px solid #f1f5f9;
      box-shadow: 2px 0 4px rgba(0, 0, 0, 0.02);
    }

    .report-table th:first-child {
      z-index: 12;
      background: #f8fafc;
    }

    /* å±¥æ­´ãƒªã‚¹ãƒˆ */
    .history-item {
      background: white;
      padding: 16px;
      border-radius: 12px;
      margin-bottom: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.04);
    }

    .h-stat {
      font-size: 0.8rem;
      padding: 4px 8px;
      border-radius: 6px;
      font-weight: bold;
    }

    .st-apply {
      background: #e0f2fe;
      color: #0284c7;
    }

    .st-ok {
      background: #dcfce7;
      color: #166534;
    }

    .st-ng {
      background: #fee2e2;
      color: #991b1b;
    }

    .st-ret {
      background: #ffedd5;
      color: #9a3412;
    }
  </style>
</head>

<body>

  <div class="app-root">
    <div id="userView" class="view-section active">
      <!-- æ—¢å­˜ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ç”»é¢ -->
      <header>
        <h1>çµŒè²»ç²¾ç®—</h1>
        <select id="applicantSelector">
          <option>èª­è¾¼ä¸­...</option>
        </select>
        <button id="helpBtn" class="help-btn" onclick="showHelp()">â“</button>
      </header>
      <div class="user-main">
        <div id="cartList" class="cart-list">
          <div class="cart-empty">ãƒ¬ã‚·ãƒ¼ãƒˆã‚’æ’®å½±ã—ã¦ãã ã•ã„</div>
        </div>

        <div class="operation-dock">
          <div class="dock-top">
            <div class="total-block">
              <div class="total-label">ç”³è«‹åˆè¨ˆ</div>
              <div class="total-price">Â¥<span id="totalDisplay">0</span></div>
            </div>
            <div style="display: flex; flex-direction: column; align-items: center; gap: 8px;">
              <div class="camera-launch-btn" onclick="openCamera()">
                <span>ğŸ“·</span><span>æ’®å½±</span>
              </div>
              <label
                style="display: flex; align-items: center; gap: 6px; font-size: 0.95rem; color: #64748b; cursor: pointer; user-select: none;">
                <input type="checkbox" id="continueMode" style="width: 18px; height: 18px; cursor: pointer;">
                <span>å‰ã®æ˜ç´°ã®ç¶šã</span>
              </label>
            </div>
          </div>
          <div class="dock-bottom">
            <button id="submitBtn" class="apply-btn" onclick="submitCart()" disabled>
              <span>ğŸ’¸</span> <span id="submitBtnText"></span>
            </button>
          </div>
        </div>
      </div>
    </div>

    <div id="historyView" class="view-section">
      <header>
        <h1>ç”³è«‹å±¥æ­´</h1>
        <div style="flex:1;"></div>
      </header>
      <div class="history-list" id="historyListContainer" style="overflow-y:auto; padding:20px; padding-bottom:100px;">
        <div style="display:flex; justify-content:center; margin-bottom:16px;">
          <select id="historyMonthPicker"
            style="padding:8px; font-size:1rem; border-radius:8px; border:1px solid #cbd5e1; background:white;"
            onchange="loadHistory()">
            <option value="ALL">å…¨æœŸé–“</option>
          </select>
        </div>
        <div id="historyInnerList">
          <div style="text-align:center; color:#64748b; margin-top:40px;">èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</div>
        </div>
      </div>
    </div>

    <div id="menuView" class="view-section" style="background:#f1f5f9;">
      <header>
        <h1>ãƒ¡ãƒ‹ãƒ¥ãƒ¼</h1>
      </header>
      <div style="padding:24px; display:flex; flex-direction:column; gap:20px; overflow-y:auto; padding-bottom:100px;">

        <!-- ç®¡ç†è€…ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
        <div id="adminMenuBlock" style="display:none;">
          <h3 style="color:#475569; margin-bottom:12px; font-size:0.95rem; font-weight:600;">ç®¡ç†è€…ãƒ¡ãƒ‹ãƒ¥ãƒ¼</h3>
          <div style="background:white; border-radius:12px; overflow:hidden; border:1px solid #e2e8f0;">
            <button class="menu-list-item" onclick="switchView('adminView'); loadAdminData();">
              <span class="ml-icon">âš¡</span>
              <span class="ml-text">æ‰¿èªãƒ»å´ä¸‹</span>
              <span class="ml-arrow">&gt;</span>
            </button>
            <button class="menu-list-item" onclick="openSubjectMaster()">
              <span class="ml-icon">ğŸ“</span>
              <span class="ml-text">ç§‘ç›®ç®¡ç†</span>
              <span class="ml-arrow">&gt;</span>
            </button>
            <button class="menu-list-item" onclick="switchView('reportMonthView'); loadMonthlyReport();">
              <span class="ml-icon">ğŸ“Š</span>
              <span class="ml-text">æœˆæ¬¡ãƒ¬ãƒãƒ¼ãƒˆ</span>
              <span class="ml-arrow">&gt;</span>
            </button>
            <button class="menu-list-item" onclick="switchView('reportDailyView'); loadDailyReport();">
              <span class="ml-icon">ğŸ“…</span>
              <span class="ml-text">æ—¥åˆ¥é›†è¨ˆ</span>
              <span class="ml-arrow">&gt;</span>
            </button>
            <button class="menu-list-item" onclick="switchView('paymentView'); loadPaymentList();">
              <span class="ml-icon">ğŸ’¸</span>
              <span class="ml-text">æ”¯æ‰•ã„ãƒ»å±¥æ­´</span>
              <span class="ml-arrow">&gt;</span>
            </button>
            <button class="menu-list-item" onclick="openDepositModal()">
              <span class="ml-icon">ğŸ’°</span>
              <span class="ml-text">å…¥é‡‘ãƒ»èª¿æ•´ç™»éŒ²</span>
              <span class="ml-arrow">&gt;</span>
            </button>
          </div>
        </div>

        <h3 style="color:#475569; margin-bottom:12px; font-size:0.95rem; font-weight:600; margin-top:20px;">ãã®ä»–</h3>
        <div style="background:white; border-radius:12px; overflow:hidden; border:1px solid #e2e8f0;">
          <div class="menu-item" onclick="showHelp()">
            <span>â“ ä½¿ã„æ–¹ã‚¬ã‚¤ãƒ‰</span>
            <span>&gt;</span>
          </div>

        </div>
      </div>
    </div>



    <!-- ç®¡ç†è€…ï¼šæœˆæ¬¡ãƒ¬ãƒãƒ¼ãƒˆç”»é¢ -->
    <div id="reportMonthView" class="view-section" style="background: #f8fafc;">
      <header style="position:sticky; top:0;">
        <button onclick="switchView('menuView')"
          style="background:none; border:none; color:var(--primary); font-size:1.2rem; font-weight:bold;">&lt;
          ãƒ¡ãƒ‹ãƒ¥ãƒ¼</button>
        <h1 style="font-size:1.2rem; margin-left:10px;">æœˆæ¬¡ãƒ¬ãƒãƒ¼ãƒˆ</h1>
      </header>
      <div style="padding:20px; padding-bottom:100px; flex: 1; overflow-y: auto;">
        <div style="display:flex; justify-content:center; margin-bottom:20px; gap:10px; align-items:center;">
          <input type="month" id="reportMonthPicker"
            style="font-size:1.1rem; padding:8px; border-radius:8px; border:1px solid #e2e8f0;"
            onchange="loadMonthlyReport()">
          <select id="reportBranchFilter"
            style="font-size:1.1rem; padding:8px; border-radius:8px; border:1px solid #e2e8f0; max-width:140px;"
            onchange="loadMonthlyReport()">
            <option value="">å…¨æ‹ ç‚¹</option>
          </select>

        </div>

        <!-- ã‚¹ã‚³ã‚¢ã‚«ãƒ¼ãƒ‰ -->
        <div class="score-grid">
          <div class="score-card sc-blue">
            <div class="sc-label">å‰æœˆç¹°è¶Š</div>
            <div class="sc-val" id="repCarry">0</div>
          </div>
          <div class="score-card sc-blue">
            <div class="sc-label">å½“æœˆå…¥é‡‘</div>
            <div class="sc-val" id="repInc">0</div>
          </div>
          <div class="score-card sc-red">
            <div class="sc-label">å½“æœˆå‡ºé‡‘</div>
            <div class="sc-val" id="repExp">0</div>
          </div>
          <div class="score-card sc-green">
            <div class="sc-label">æœ€çµ‚æ®‹é«˜</div>
            <div class="sc-val" id="repBal">0</div>
          </div>
        </div>

        <!-- ã‚°ãƒªãƒƒãƒ‰è¡¨ -->
        <div
          style="overflow-x:auto; margin-top:24px; background:white; border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,0.05);">
          <table id="monthlyGrid" class="report-table"></table>
        </div>

        <!-- ã‚¤ãƒ³ãƒœã‚¤ã‚¹é›†è¨ˆ -->
        <h3 style="margin-top:30px; color:#475569;">ã‚¤ãƒ³ãƒœã‚¤ã‚¹åˆ¥é›†è¨ˆ (æ”¯å‡º)</h3>
        <div style="background:white; border-radius:12px; overflow:hidden; box-shadow:0 2px 8px rgba(0,0,0,0.05);">
          <table class="report-table" id="invoiceTable">
            <thead>
              <tr>
                <th>ç™»éŒ²</th>
                <th>ç¨ç‡</th>
                <th>é‡‘é¡</th>
              </tr>
            </thead>
            <tbody id="invoiceBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ç®¡ç†è€…ï¼šæ—¥åˆ¥(äººåˆ¥)ãƒ¬ãƒãƒ¼ãƒˆç”»é¢ -->
    <div id="reportDailyView" class="view-section" style="background: #f8fafc;">
      <header style="position:sticky; top:0;">
        <button onclick="switchView('menuView')"
          style="background:none; border:none; color:var(--primary); font-size:1.2rem; font-weight:bold;">&lt;
          ãƒ¡ãƒ‹ãƒ¥ãƒ¼</button>
        <h1 style="font-size:1.2rem; margin-left:10px;">ç”³è«‹è€…åˆ¥é›†è¨ˆ</h1>
      </header>
      <div style="padding:20px; padding-bottom:100px; flex: 1; overflow-y: auto;">
        <div style="display:flex; justify-content:center; margin-bottom:20px; gap:10px; align-items:center;">
          <input type="month" id="dailyReportMonthPicker"
            style="font-size:1.1rem; padding:8px; border-radius:8px; border:1px solid #e2e8f0;"
            onchange="loadDailyReport()">
          <select id="dailyReportBranchFilter"
            style="font-size:1.1rem; padding:8px; border-radius:8px; border:1px solid #e2e8f0; max-width:140px;"
            onchange="loadDailyReport()">
            <option value="">å…¨æ‹ ç‚¹</option>
          </select>
        </div>
        <div id="dailyPersonList" style="display:flex; flex-direction:column; gap:12px;"></div>
      </div>
    </div>

    <form id="ocrForm" style="display:none;"><input type="file" id="rFile" name="receiptFile" accept="image/*"
        capture="environment" onchange="handleFile(this)"></form>

    <!-- ãƒ•ãƒƒã‚¿ãƒ¼ãƒŠãƒ“ -->
    <nav class="app-nav">
      <button class="nav-btn active" onclick="switchView('userView')" id="navApply">
        <div class="nav-icon">ğŸ“</div>
        <div class="nav-text">ç”³è«‹</div>
      </button>
      <button class="nav-btn" onclick="switchView('historyView'); loadHistory();" id="navHistory">
        <div class="nav-icon">ğŸ•’</div>
        <div class="nav-text">å±¥æ­´</div>
      </button>
      <button class="nav-btn" onclick="switchView('menuView')" id="navMenu">
        <div class="nav-icon">âš™ï¸</div>
        <div class="nav-text">ãƒ¡ãƒ‹ãƒ¥ãƒ¼</div>
      </button>
    </nav>

    <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«é¡ã¯å¤‰æ›´ãªã— -->
    <div id="editModal" class="edit-modal" onclick="if(event.target===this) closeEdit()">
      <div class="edit-sheet">
        <div class="sheet-handle"></div>
        <div class="edit-img-box">
          <img id="eImg" class="edit-img">
        </div>
        <div class="input-group">
          <label>åˆ©ç”¨æ—¥</label>
          <input type="date" id="eDate"
            style="padding: 12px; font-size: 1rem; border-radius: 8px; border: 1px solid #e2e8f0;">
        </div>
        <div class="input-group">
          <label>é‡‘é¡ (ç¨è¾¼)</label>
          <input type="number" id="eAmt" placeholder="0">
        </div>
        <div class="input-group">
          <label>ç¨ç‡</label>
          <select id="eTax" style="padding: 12px; font-size: 1rem; border-radius: 8px; border: 1px solid #e2e8f0;">
            <option value="10">10%</option>
            <option value="8">8%</option>
          </select>
        </div>
        <div class="input-group">
          <label>åº—å</label>
          <input type="text" id="eVen" placeholder="åº—å">
        </div>
        <div class="input-group">
          <label>ç§‘ç›®</label>
          <input type="text" id="eSub" placeholder="æ¶ˆè€—å“è²»ãªã©" onchange="updateTaxRateBySubject()">
        </div>
        <div class="input-group">
          <label>å‚™è€ƒãƒ»åˆ©ç”¨ç›®çš„</label>
          <textarea id="ePurpose" placeholder="ä¼šè­°è²»ã€æ¥å¾…ãªã©è©³ç´°ã‚’å…¥åŠ›"
            style="padding: 12px; font-size: 1rem; border-radius: 8px; border: 1px solid #e2e8f0; resize: vertical; min-height: 60px;"></textarea>
        </div>
        <button class="btn-save" onclick="saveEdit()">æ±ºå®š</button>
      </div>
    </div>

    <div id="adminView" class="view-section">
      <div class="admin-tools">
        <div style="display: flex; align-items: center; gap: 12px; flex: 1;">
          <div style="position: relative;">
            <div
              style="position:absolute; left:12px; top:50%; transform:translateY(-50%); pointer-events:none; font-size:1.1rem;">
              ğŸ”</div>
            <select id="applicantFilter" style="
              padding: 10px 14px 10px 42px; 
              border-radius: 20px; 
              border: 1px solid rgba(255, 255, 255, 0.2);
              background: rgba(255,255,255,0.1); 
              color: white; 
              font-size: 0.95rem; 
              font-weight: 500; 
              min-width: 180px;
              appearance: none;
              cursor: pointer;
              transition: all 0.2s;
            " onfocus="this.style.background='rgba(255,255,255,0.2)'"
              onblur="this.style.background='rgba(255,255,255,0.1)'">
              <option value="" style="color:#333;">å…¨ã¦ã®ç”³è«‹è€…</option>
            </select>
          </div>

          <div id="filterTotalDisplay" style="
            display: none; padding: 6px 14px; border-radius: 20px; 
            background: rgba(16, 185, 129, 0.2);
            color: #34d399; font-weight: 600; font-size: 0.9rem;
            border: 1px solid rgba(16, 185, 129, 0.3);
          ">
            è¨ˆ: Â¥<span id="filterTotal">0</span>
          </div>
        </div>
        <button class="tool-btn" onclick="openSubjectMaster()">
          ğŸ“ ç§‘ç›®ãƒã‚¹ã‚¿ç®¡ç†
        </button>
      </div>
      <main class="admin-main">
        <div id="cardContainer" class="card-container">
          <div style="color:white; margin:auto; text-align:center; font-size:1.2rem; font-weight:600; opacity:0.8;">
            <div style="font-size:2rem; margin-bottom:16px;">â³</div>
            ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...
          </div>
        </div>
      </main>
    </div>

    <!-- æ”¯æ‰•ã„ç®¡ç†ç”»é¢ -->
    <div id="paymentView" class="view-section" style="background:#f8fafc;">
      <header style="position:sticky; top:0;">
        <button onclick="switchView('menuView')"
          style="background:none; border:none; color:var(--primary); font-size:1.2rem; font-weight:bold;">&lt;
          ãƒ¡ãƒ‹ãƒ¥ãƒ¼</button>
        <h1 style="font-size:1.2rem; margin-left:10px;">æ”¯æ‰•ã„ãƒ»å±¥æ­´</h1>
      </header>
      <div style="padding:20px; padding-bottom:100px; flex: 1; overflow-y: auto;">
        <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚¨ãƒªã‚¢ -->
        <div
          style="display:flex; flex-wrap:wrap; gap:10px; justify-content:center; align-items:center; margin-bottom:16px;">
          <div
            style="display:flex; align-items:center; gap:4px; background:white; padding:4px 12px; border-radius:12px; border:1px solid #cbd5e1; box-shadow:0 2px 6px rgba(0,0,0,0.05);">
            <span style="font-size:0.8rem; font-weight:bold; color:#64748b;">æœŸé–“</span>
            <input type="date" id="paymentStartDatePicker"
              style="border:none; outline:none; font-size:1rem; padding:4px;" onchange="loadPaymentList()">
            <span style="color:#cbd5e1;">ã€œ</span>
            <input type="date" id="paymentEndDatePicker" style="border:none; outline:none; font-size:1rem; padding:4px;"
              onchange="loadPaymentList()">
          </div>
          <select id="paymentApplicantFilter"
            style="padding:8px; font-size:1rem; border-radius:8px; border:1px solid #cbd5e1; min-width:150px;"
            onchange="filterPaymentList()">
            <option value="">å…¨å“¡</option>
            <!-- JSã§å‹•çš„ã«è¿½åŠ  -->
          </select>
          <select id="paymentStatusFilter"
            style="padding:8px; font-size:1rem; border-radius:8px; border:1px solid #cbd5e1;"
            onchange="filterPaymentList()">
            <option value="">å…¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</option>
            <option value="æœªæ‰•ã„">æœªæ‰•ã„ã®ã¿</option>
            <option value="æ”¯æ‰•æ¸ˆ">æ”¯æ‰•æ¸ˆã®ã¿</option>
          </select>
        </div>
        <!-- åˆè¨ˆè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
        <div id="paymentSummaryArea"
          style="background:linear-gradient(135deg, #3b82f6, #1d4ed8); color:white; padding:16px; border-radius:12px; margin-bottom:16px; display:none;">
          <div style="display:flex; justify-content:space-between; align-items:center;">
            <div>
              <div style="font-size:0.9rem; opacity:0.8;">çµè¾¼çµæœ</div>
              <div id="paymentSummaryLabel" style="font-size:1rem; font-weight:bold;">-</div>
            </div>
            <div style="text-align:right;">
              <div style="font-size:0.9rem; opacity:0.8;">åˆè¨ˆé‡‘é¡</div>
              <div id="paymentSummaryTotal" style="font-size:1.5rem; font-weight:bold;">Â¥0</div>
            </div>
          </div>
          <div style="display:flex; gap:16px; margin-top:12px; font-size:0.9rem;">
            <div><span style="opacity:0.8;">æœªæ‰•ã„:</span> <span id="paymentSummaryUnpaid">Â¥0</span></div>
            <div><span style="opacity:0.8;">æ”¯æ‰•æ¸ˆ:</span> <span id="paymentSummaryPaid">Â¥0</span></div>
            <div><span style="opacity:0.8;">ä»¶æ•°:</span> <span id="paymentSummaryCount">0</span>ä»¶</div>
          </div>
        </div>
        <div id="paymentListContainer" style="display:flex; flex-direction:column; gap:12px;">
          <!-- JSã§æç”» -->
        </div>
      </div>
    </div>

    <!-- å…¥é‡‘ç™»éŒ²ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="depositModal" class="master-modal">
      <div class="master-box" style="width: 90%; max-width: 400px; padding:24px;">
        <h3 style="text-align:center; margin-bottom:20px; color:#10b981;">ğŸ’° å…¥é‡‘ãƒ»è³‡é‡‘ç§»å‹•ã®ç™»éŒ²</h3>

        <div class="input-group">
          <label>æ—¥ä»˜</label>
          <input type="date" id="depDate"
            style="padding: 12px; font-size: 1rem; border-radius: 8px; border: 1px solid #e2e8f0; width:100%; box-sizing:border-box;">
        </div>

        <div class="input-group">
          <label>ç¨®åˆ¥</label>
          <select id="depType"
            style="padding: 12px; font-size: 1rem; border-radius: 8px; border: 1px solid #e2e8f0; width:100%; box-sizing:border-box;">
            <option value="å…¥é‡‘">å…¥é‡‘</option>
            <option value="å‡ºé‡‘">å‡ºé‡‘</option>
            <option value="èª¿æ•´">èª¿æ•´</option>
          </select>
        </div>

        <div class="input-group">
          <label>é‡‘é¡ (å††)</label>
          <input type="number" id="depAmt" placeholder="0"
            style="padding: 12px; font-size: 1rem; border-radius: 8px; border: 1px solid #e2e8f0; width:100%; box-sizing:border-box;">
        </div>

        <div class="input-group">
          <label>æ‹ ç‚¹ (æŒ‡å®šãªã—ã§å…¨æ‹ ç‚¹æ‰±ã„)</label>
          <select id="depBranch"
            style="padding: 12px; font-size: 1rem; border-radius: 8px; border: 1px solid #e2e8f0; width:100%; box-sizing:border-box;">
            <option value="">æŒ‡å®šãªã—</option>
          </select>
        </div>

        <div class="input-group">
          <label>æ‹ ç‚¹ (æŒ‡å®šãªã—ã§å…¨æ‹ ç‚¹æ‰±ã„)</label>
          <select id="depBranch"
            style="padding: 12px; font-size: 1rem; border-radius: 8px; border: 1px solid #e2e8f0; width:100%; box-sizing:border-box;">
            <option value="">æŒ‡å®šãªã—</option>
          </select>
        </div>

        <div class="input-group">
          <label>ãƒ¡ãƒ¢ (å£²ä¸Šã€è³‡é‡‘ç§»å‹•ãªã©)</label>
          <input type="text" id="depMemo" placeholder="è©³ç´°ã‚’å…¥åŠ›"
            style="padding: 12px; font-size: 1rem; border-radius: 8px; border: 1px solid #e2e8f0; width:100%; box-sizing:border-box;">
        </div>

        <div style="display:flex; gap:10px; margin-top:20px;">
          <button class="btn-save" style="flex:1; background:#e2e8f0; color:#475569;"
            onclick="closeDepositModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          <button class="btn-save" style="flex:1; background:linear-gradient(135deg, #10b981, #059669);"
            onclick="registerDeposit()">ç™»éŒ²</button>
        </div>
      </div>
    </div>

    <div id="subjectModal" class="master-modal">
      <div class="master-box" style="width: 90%; max-width: 400px;">
        <h3>ç§‘ç›®ãƒã‚¹ã‚¿</h3>
        <div class="input-group">
          <label>ç§‘ç›®å</label>
          <input id="newSubject" type="text" placeholder="ä¾‹: æ¶ˆè€—å“è²»">
        </div>
        <div style="display:flex; gap:8px;">
          <div class="input-group" style="flex:1;">
            <label>ç¨ç‡%</label>
            <input id="newTax" type="number" placeholder="10" value="10">
          </div>
          <div class="input-group" style="flex:2;">
            <label>ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰</label>
            <input id="newKw" type="text" placeholder="ä»»æ„">
          </div>
        </div>
        <div style="margin-top:8px; display:flex; justify-content:flex-end; gap:8px;">
          <button id="updateSubBtn" onclick="updateSubject()"
            style="display:none; padding:8px 16px; background:#f59e0b; color:white; border:none; border-radius:6px; font-weight:bold;">æ›´æ–°</button>
          <button id="addSubBtn" onclick="addSubject()"
            style="padding:8px 16px; background:var(--primary); color:white; border:none; border-radius:6px; font-weight:bold;">è¿½åŠ </button>
        </div>

        <div id="subjectListDiv" class="master-list"></div>
        <button onclick="closeSubjectMaster()"
          style="margin-top:16px; width:100%; padding:12px; background:#f1f5f9; border:none; border-radius:8px; font-weight:bold; color:#475569;">é–‰ã˜ã‚‹</button>
      </div>
    </div>

    <!-- History Edit Modal for Re-judging -->
    <div id="historyEditModal" class="master-modal" style="z-index: 950;">
      <div class="master-box"
        style="width: 95%; max-width: 600px; max-height: 90vh; display:flex; flex-direction:column; padding:0; overflow:hidden;">
        <div
          style="padding:16px; background:#f8fafc; border-bottom:1px solid #e2e8f0; display:flex; justify-content:space-between; align-items:center;">
          <h3 style="margin:0; color:#334155;">è©³ç´°ãƒ»ä¿®æ­£ (å†åˆ¤å®š)</h3>
          <button onclick="closeHistoryEdit()"
            style="border:none; background:none; font-size:1.5rem; color:#64748b; cursor:pointer;">&times;</button>
        </div>
        <div id="historyEditContent"
          style="padding:16px; overflow-y:auto; flex:1; background:#ffffff; min-height: 300px;">
          <!-- Admin Card will be injected here -->
        </div>
      </div>
    </div>

    <div id="helpModal" class="help-modal" onclick="if(event.target===this) closeHelp()">
      <div class="help-content">
        <div class="help-header">
          <h2>ğŸ“± ä½¿ã„æ–¹ã‚¬ã‚¤ãƒ‰</h2>
        </div>
        <div class="help-body">
          <div class="help-section">
            <h3>ğŸš€ åŸºæœ¬ã®ä½¿ã„æ–¹</h3>
            <p><strong>1. ãƒ¬ã‚·ãƒ¼ãƒˆæ’®å½±</strong><br>ğŸ“·æ’®å½±ãƒœã‚¿ãƒ³ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ãƒ¬ã‚·ãƒ¼ãƒˆã‚’æ’®å½±</p>
            <p><strong>2. å†…å®¹ç¢ºèª</strong><br>AIãŒè‡ªå‹•ã§é‡‘é¡ãƒ»åº—åãƒ»ç§‘ç›®ã‚’èª­ã¿å–ã‚Šã¾ã™</p>
            <p><strong>3. ç·¨é›†ï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰</strong><br>ã‚«ãƒ¼ãƒ‰ã‚’ã‚¿ãƒƒãƒ—ã—ã¦å†…å®¹ã‚’ä¿®æ­£</p>
            <p><strong>4. ç”³è«‹é€ä¿¡</strong><br>ğŸ’¸ã¾ã¨ã‚ã¦ç”³è«‹ãƒœã‚¿ãƒ³ã§é€ä¿¡</p>
          </div>

          <div class="help-section">
            <h3>ğŸ“¸ æ’®å½±ã®ã‚³ãƒ„</h3>
            <ul>
              <li>æ˜ã‚‹ã„å ´æ‰€ã§æ’®å½±ã™ã‚‹</li>
              <li>ãƒ¬ã‚·ãƒ¼ãƒˆå…¨ä½“ã‚’ç”»é¢ã«åã‚ã‚‹</li>
              <li>å¹³ã‚‰ãªå ´æ‰€ã«ç½®ã„ã¦çœŸä¸Šã‹ã‚‰æ’®å½±</li>
              <li>æ‰‹ã¶ã‚Œã—ãªã„ã‚ˆã†ã«ã‚†ã£ãã‚Šã¨</li>
            </ul>
          </div>

          <div class="help-section">
            <h3>ğŸ“ é•·ã„ãƒ¬ã‚·ãƒ¼ãƒˆã®æ’®å½±</h3>
            <p><strong>1æšã«åã¾ã‚‰ãªã„é•·ã„ãƒ¬ã‚·ãƒ¼ãƒˆã®å ´åˆï¼š</strong></p>
            <ol>
              <li>ã¾ãšä¸ŠåŠåˆ†ã‚’æ’®å½±</li>
              <li>ã€Œå‰ã®æ˜ç´°ã®ç¶šãã€ã«ãƒã‚§ãƒƒã‚¯âœ“</li>
              <li>ä¸‹åŠåˆ†ã‚’æ’®å½±</li>
              <li>é‡‘é¡ãŒè‡ªå‹•ã§åˆç®—ã•ã‚Œã¾ã™</li>
            </ol>
            <p style="font-size:0.95rem; color:#64748b; margin-top:8px;">â€»ç”»åƒã¯ä¸¡æ–¹ã¨ã‚‚ä¿å­˜ã•ã‚Œã€ã‚«ãƒ¼ãƒ‰ã«ã€ŒÃ—2ã€ã¨è¡¨ç¤ºã•ã‚Œã¾ã™</p>
          </div>

          <div class="help-section">
            <h3>âœï¸ ç·¨é›†æ©Ÿèƒ½</h3>
            <p>ãƒ¬ã‚·ãƒ¼ãƒˆã‚«ãƒ¼ãƒ‰ã‚’ã‚¿ãƒƒãƒ—ã™ã‚‹ã¨ç·¨é›†ç”»é¢ãŒé–‹ãã¾ã™ï¼š</p>
            <ul>
              <li><strong>é‡‘é¡</strong>ï¼šèª­ã¿å–ã‚ŠãŒä¸æ­£ç¢ºãªå ´åˆã«ä¿®æ­£</li>
              <li><strong>åº—å</strong>ï¼šæ­£ã—ã„åº—èˆ—åã«å¤‰æ›´</li>
              <li><strong>ç§‘ç›®</strong>ï¼šé©åˆ‡ãªçµŒè²»ç§‘ç›®ã‚’é¸æŠ</li>
            </ul>
          </div>

          <div class="help-section">
            <h3>ğŸ”§ ã‚ˆãã‚ã‚‹å•é¡Œ</h3>
            <p><strong>é‡‘é¡ãŒ0å††ã«ãªã‚‹</strong><br>â†’ æ˜ã‚‹ã„å ´æ‰€ã§å†æ’®å½±ã™ã‚‹ã‹ã€æ‰‹å‹•ã§å…¥åŠ›</p>
            <p><strong>åº—åãŒèª­ã‚ãªã„</strong><br>â†’ ç·¨é›†ç”»é¢ã§æ­£ã—ã„åº—åã‚’å…¥åŠ›</p>
            <p><strong>ç§‘ç›®ãŒã‚ã‹ã‚‰ãªã„</strong><br>â†’ ç®¡ç†è€…ã«ç¢ºèªã—ã¦ãã ã•ã„</p>
          </div>

          <div class="help-section">
            <h3>ğŸ“‹ ç”³è«‹å‰ãƒã‚§ãƒƒã‚¯</h3>
            <ul>
              <li>âœ… é‡‘é¡ãŒæ­£ã—ãå…¥åŠ›ã•ã‚Œã¦ã„ã‚‹</li>
              <li>âœ… åº—åãŒæ­£ã—ãå…¥åŠ›ã•ã‚Œã¦ã„ã‚‹</li>
              <li>âœ… é©åˆ‡ãªç§‘ç›®ãŒé¸æŠã•ã‚Œã¦ã„ã‚‹</li>
              <li>âœ… ãƒ¬ã‚·ãƒ¼ãƒˆç”»åƒãŒã¯ã£ãã‚Šè¦‹ãˆã‚‹</li>
            </ul>
          </div>
        </div>
        <div class="help-footer">
          <button onclick="closeHelp()"
            style="padding:12px 24px; background:#06b6d4; color:white; border:none; border-radius:12px; font-weight:bold; font-size:1.1rem;">é–‰ã˜ã‚‹</button>
        </div>
      </div>
    </div>

  </div>

  <div id="confirmToast" class="confirm-toast">
    <div id="confirmMsg" style="font-weight:900; font-size:1.1rem; text-align:center;">å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ</div>
    <div class="confirm-actions">
      <button class="c-btn c-no" onclick="closeConfirm()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="c-btn c-yes" id="confirmYesBtn">å®Ÿè¡Œ</button>
    </div>
  </div>

  <div id="returnModal" class="confirm-toast" style="display: none;">
    <div style="font-weight:900; font-size:1.1rem; text-align:center; margin-bottom: 16px;">å·®ã—æˆ»ã—ç†ç”±ã‚’å…¥åŠ›</div>
    <textarea id="returnComment" placeholder="ä¾‹: é ˜åæ›¸ãŒä¸é®®æ˜ã§ã™ã€‚å†æå‡ºã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚" rows="4"
      style="width: 100%; padding: 12px; font-size: 1rem; border: 2px solid #e2e8f0; border-radius: 8px; resize: vertical;"></textarea>
    <div class="confirm-actions" style="margin-top: 16px;">
      <button class="c-btn c-no" onclick="closeReturnModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="c-btn c-yes" onclick="execReturn()">å·®ã—æˆ»ã™</button>
    </div>
  </div>

  <div id="loadingOverlay">
    <div class="spinner"></div>
    <div id="loadText" style="margin-top:10px; font-weight:bold;">å‡¦ç†ä¸­...</div>
  </div>
  <div id="toast"></div>
  <div id="imageModal" onclick="this.style.display='none'">
    <img id="zoomImg">
  </div>

  <script>
    let cartItems = [];
    let subjectMaster = [];
    let subjectMasterWithTax = []; // ç¨ç‡æƒ…å ±ä»˜ãç§‘ç›®ãƒã‚¹ã‚¿
    let editingId = null;
    let isAdminMode = false;
    let pendingAppId = null;
    let pendingAction = null;
    let allPendingList = []; // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ç”¨ã®å…¨ãƒ‡ãƒ¼ã‚¿ä¿å­˜
    let lastPaymentList = []; // æ”¯æ‰•ã„ç®¡ç†ç”»é¢ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒ

    window.onload = function () {
      google.script.run.withSuccessHandler(initData).getInitData();
      // PCã§ã®æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«è£œåŠ©
      // PCã§ã®æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«è£œåŠ© (å»ƒæ­¢: ç¸¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é˜»å®³ã®ãŸã‚)
      // const con = document.getElementById('cardContainer');
      // con.addEventListener('wheel', ...);
    };

    let editingAppId = null; // ç”³è«‹ç·¨é›†ãƒ¢ãƒ¼ãƒ‰æ™‚ã®ID

    function initData(data) {
      const sel = document.getElementById('applicantSelector');
      sel.innerHTML = '';
      data.list.forEach(u => {
        const op = document.createElement('option');
        op.value = u.id; op.text = u.name;
        if (normalize(u.email) === normalize(data.currentUser.email)) op.selected = true;
        sel.appendChild(op);
      });

      // ç®¡ç†è€…ãªã‚‰ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«ç®¡ç†è€…é …ç›®ã‚’è¡¨ç¤º
      if (data.currentUser.role === 'ADMIN') {
        document.getElementById('adminMenuBlock').style.display = 'block';
      }

      // ç§‘ç›®ãƒã‚¹ã‚¿ï¼ˆç¨ç‡æƒ…å ±ä»˜ãï¼‰ã‚’ä¿å­˜
      subjectMasterWithTax = data.subjectMaster || [];
      subjectMaster = (data.subjectMaster || []).map(s => s.name);

      // ä»Šæœˆ/ä»Šæ—¥ã‚’åˆæœŸå€¤ã«ã‚»ãƒƒãƒˆ
      const now = new Date();
      const ym = now.getFullYear() + '-' + ('0' + (now.getMonth() + 1)).slice(-2);
      const ymd = ym + '-' + ('0' + now.getDate()).slice(-2);

      document.getElementById('reportMonthPicker').value = ym;

      const dailyPicker = document.getElementById('dailyReportMonthPicker');
      if (dailyPicker) {
        dailyPicker.type = 'date';
        dailyPicker.value = ymd;
      }
    }

    function cancelEditMode() {
      if (!confirm('ç·¨é›†å†…å®¹ã‚’ç ´æ£„ã—ã¦æ–°è¦ä½œæˆã«æˆ»ã‚Šã¾ã™ã‹ï¼Ÿ')) return;
      editingAppId = null;
      cartItems = [];
      renderCart();
    }

    // ========== ç”»é¢é·ç§»ãƒ­ã‚¸ãƒƒã‚¯ ==========
    function switchView(viewId) {
      // å…¨ã¦ã®ãƒ“ãƒ¥ãƒ¼ã‚’éè¡¨ç¤º
      document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
      // æŒ‡å®šãƒ“ãƒ¥ãƒ¼ã‚’è¡¨ç¤º
      document.getElementById(viewId).classList.add('active');

      // ãƒ•ãƒƒã‚¿ãƒ¼ãƒŠãƒ“ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹æ›´æ–°
      document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));

      if (viewId === 'userView') {
        document.getElementById('navApply').classList.add('active');
        // App Mode: Fixed viewport
        document.documentElement.style.overflowY = 'hidden';
        document.body.style.overflowY = 'hidden';
        document.body.style.height = '100dvh';
      } else if (viewId === 'historyView') {
        document.getElementById('navHistory').classList.add('active');
        document.documentElement.style.overflowY = 'hidden';
        document.body.style.overflowY = 'hidden';
        document.body.style.height = '100dvh';
      } else if (viewId === 'menuView' || viewId.startsWith('report')) {
        document.getElementById('navMenu').classList.add('active');
        // Menu/Report might need scroll? Start with fixed to be safe, or auto if content long.
        // Usually menu fits, report might need scroll. Let's force scrolling for report?
        // For now, keep App Mode default for simplicity unless admin.
        document.documentElement.style.overflowY = 'hidden';
        document.body.style.overflowY = 'hidden';
        document.body.style.height = '100dvh';
      } else if (viewId === 'adminView' || viewId === 'paymentView') {
        document.getElementById('navMenu').classList.add('active');
        // Admin Mode & Payment View: Global Scroll
        document.documentElement.style.overflowY = 'auto';
        document.body.style.overflowY = 'auto';
        document.body.style.height = 'auto';
      }
    }

    // ========== å±¥æ­´æ©Ÿèƒ½ ==========
    // ========== å±¥æ­´æ©Ÿèƒ½ ==========
    function loadHistory() {
      // æœˆãƒ”ãƒƒã‚«ãƒ¼åˆæœŸåŒ–
      const picker = document.getElementById('historyMonthPicker');

      // é¸æŠè‚¢ãŒã¾ã ãªã„å ´åˆï¼ˆåˆå›ï¼‰
      if (picker.options.length <= 1) {
        const now = new Date();
        // ç›´è¿‘12ãƒ¶æœˆåˆ†ç”Ÿæˆ
        for (let i = 0; i < 12; i++) {
          const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
          const val = d.getFullYear() + '-' + ('0' + (d.getMonth() + 1)).slice(-2);
          const txt = d.getFullYear() + 'å¹´' + (d.getMonth() + 1) + 'æœˆ';
          const op = document.createElement('option');
          op.value = val; op.text = txt;
          if (i === 0) op.selected = true; // ä»Šæœˆ
          picker.appendChild(op);
        }
      }

      const targetMonth = picker.value || '';
      const listEl = document.getElementById('historyInnerList');
      if (listEl) listEl.innerHTML = '<div style="text-align:center; color:#64748b; margin-top:40px;">èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</div>';

      google.script.run.withSuccessHandler(list => {
        if (!list || list.length === 0) {
          listEl.innerHTML = '<div style="text-align:center; color:#64748b; margin-top:40px;">å±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
          return;
        }

        // ç”»åƒä¸€æ‹¬å–å¾—ç”¨IDãƒªã‚¹ãƒˆ
        const allFileIds = [];
        list.forEach(item => {
          if (item.firstImageId) allFileIds.push(item.firstImageId);
        });

        listEl.innerHTML = list.map(item => {
          let stClass = 'st-apply';
          if (item.statusLabel === 'æ‰¿èªæ¸ˆ' || item.statusLabel === 'çµŒç†ç¢ºå®š') stClass = 'st-ok';
          else if (item.statusLabel === 'å´ä¸‹') stClass = 'st-ng';
          else if (item.statusLabel === 'å·®ã—æˆ»ã—') stClass = 'st-ret';

          // ç”»åƒã‚µãƒ ãƒã‚¤ãƒ«
          let thumbHtml = '';
          if (item.firstImageId) {
            const imgId = 'h-img-' + item.applicationId;
            thumbHtml = `<div style="width:50px; height:50px; border-radius:6px; overflow:hidden; background:#f1f5f9; margin-right:12px; flex-shrink:0; cursor:pointer;" onclick="zoomImage('${imgId}')">
                <img id="${imgId}" style="width:100%; height:100%; object-fit:cover;" data-file-id="${item.firstImageId}" src="">
             </div>`;
          } else {
            thumbHtml = `<div style="width:50px; height:50px; border-radius:6px; background:#f1f5f9; display:flex; align-items:center; justify-content:center; color:#cbd5e1; margin-right:12px; flex-shrink:0;">
                <span>ğŸ“·</span>
             </div>`;
          }

          const canEdit = (item.statusLabel !== 'æ‰¿èªæ¸ˆ' && item.statusLabel !== 'çµŒç†ç¢ºå®š');
          const editBtn = canEdit
            ? `<button onclick="loadApplicationForEdit('${item.applicationId}')" style="margin-top:8px; padding:6px 12px; border:1px solid #cbd5e1; border-radius:6px; background:white; font-size:0.8rem; color:#334155; cursor:pointer;">âœ ç·¨é›†ãƒ»å†ç”³è«‹</button>`
            : '';

          return `
            <div class="history-item">
              <div style="display:flex; align-items:center; flex:1;">
                 ${thumbHtml}
                 <div style="display:flex; flex-direction:column; gap:4px; flex:1;">
                    <div style="font-weight:bold; color:#1e293b;">${item.displayDate}</div>
                    <div style="font-size:0.85rem; color:#64748b;">${item.statusLabel === 'ç”³è«‹ä¸­' ? 'ç”³è«‹ä¸­' : item.statusLabel}</div>
                    ${editBtn}
                 </div>
              </div>
              <div style="display:flex; flex-direction:column; align-items:flex-end; gap:4px;">
                <div style="font-weight:900; font-size:1.1rem; color:#0f172a;">Â¥${Number(item.totalAmount).toLocaleString()}</div>
                <div class="h-stat ${stClass}">${item.statusLabel}</div>
              </div>
            </div>
          `;
        }).join('');

        // ä¸€æ‹¬ç”»åƒãƒ­ãƒ¼ãƒ‰å®Ÿè¡Œ
        if (allFileIds.length > 0) {
          google.script.run.withSuccessHandler(imgMap => {
            Object.keys(imgMap).forEach(fid => {
              const b64 = imgMap[fid];
              const targets = document.querySelectorAll(`img[data-file-id="${fid}"]`);
              targets.forEach(img => {
                if (b64) img.src = b64;
                else img.parentNode.innerHTML = '<span style="font-size:0.6rem; color:red;">x</span>';
              });
            });
          }).api_getImagesBatch(allFileIds);
        }

      }).withFailureHandler(e => {
        listEl.innerHTML = '<div style="color:red; text-align:center;">èª­ã¿è¾¼ã¿å¤±æ•—</div>';
        showToast('ã‚¨ãƒ©ãƒ¼: ' + e.message, 'error');
      }).api_getMyHistory(targetMonth);
    }

    function loadApplicationForEdit(appId) {
      if (cartItems.length > 0) {
        if (!confirm('ç¾åœ¨å…¥åŠ›ä¸­ã®å†…å®¹ã¯ç ´æ£„ã•ã‚Œã¾ã™ãŒã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) return;
      }
      showLoad('ç”³è«‹ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­...');
      google.script.run.withSuccessHandler(res => {
        hideLoad();
        editingAppId = appId;
        cartItems = res.items;
        renderCart();
        switchView('userView');
        showToast('ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã«ãªã‚Šã¾ã—ãŸ');
      }).withFailureHandler(e => {
        hideLoad();
        showToast('å–å¾—ã‚¨ãƒ©ãƒ¼: ' + e.message, 'error');
      }).api_getApplication(appId);
    }

    // ========== ãƒ¬ãƒãƒ¼ãƒˆæ©Ÿèƒ½ ==========
    function loadMonthlyReport() {
      const m = document.getElementById('reportMonthPicker').value;
      if (!m) return;

      document.getElementById('monthlyGrid').innerHTML = '<tr><td colspan="100" style="text-align:center;">èª­ã¿è¾¼ã¿ä¸­...</td></tr>';

      google.script.run.withSuccessHandler(res => {
        renderMonthlyReport(res);
      }).withFailureHandler(e => {
        showToast('ãƒ¬ãƒãƒ¼ãƒˆå–å¾—å¤±æ•—: ' + e.message, 'error');
      }).api_getMonthlyReport(m, document.getElementById('reportBranchFilter').value);
    }

    function renderMonthlyReport(data) {
      // ã‚¹ã‚³ã‚¢ã‚«ãƒ¼ãƒ‰
      const sc = data.scorecard;
      document.getElementById('repCarry').innerText = 'Â¥' + data.carryOver.toLocaleString();
      document.getElementById('repInc').innerText = 'Â¥' + sc.income.toLocaleString();
      document.getElementById('repExp').innerText = 'Â¥' + sc.expense.toLocaleString();
      document.getElementById('repBal').innerText = 'Â¥' + data.totalBalance.toLocaleString();

      // ã‚°ãƒªãƒƒãƒ‰
      const grid = data.grid;
      const tbl = document.getElementById('monthlyGrid');
      let thHtml = '<thead><tr><th>æ—¥ä»˜</th>';
      grid.subjects.forEach(s => thHtml += `<th>${s}</th>`);
      thHtml += '<th>å…¥é‡‘</th><th>å‡ºé‡‘</th><th>æ®‹é«˜</th></tr></thead>'; // æ®‹é«˜åˆ—è¿½åŠ 

      let tbHtml = '<tbody>';
      grid.days.forEach(day => {
        // æ—¥ä»˜ãƒ©ãƒ™ãƒ«
        const parts = day.split('-');
        const dLabel = `${Number(parts[1])}/${Number(parts[2])}`;
        let rowHtml = `<tr><td>${dLabel}</td>`;
        let dData = grid.data[day];

        grid.subjects.forEach(sub => {
          const val = dData.subjects[sub] || 0;
          rowHtml += `<td style="color:${val === 0 ? '#cbd5e1' : '#0f172a'}">Â¥${val.toLocaleString()}</td>`;
        });

        // å…¥é‡‘ãƒ»å‡ºé‡‘ãƒ»æ®‹é«˜
        rowHtml += `<td style="color:#059669; font-weight:bold;">Â¥${dData.income.toLocaleString()}</td>`;
        rowHtml += `<td style="color:#dc2626; font-weight:bold;">Â¥${dData.expense.toLocaleString()}</td>`;
        rowHtml += `<td style="font-weight:900;">Â¥${dData.balance.toLocaleString()}</td>`;

        rowHtml += `</tr>`;
        tbHtml += rowHtml;
      });
      tbHtml += '</tbody>';
      tbl.innerHTML = thHtml + tbHtml;

      // ã‚¤ãƒ³ãƒœã‚¤ã‚¹ã‚µãƒãƒª (å…¨ä½“ + ç§‘ç›®åˆ¥)
      const invBody = document.getElementById('invoiceBody');
      const inv = data.invoice;
      let invHtml = '';

      // --- å…¨ä½“ ---
      invHtml += '<tr style="background:#f1f5f9;"><td colspan="4" style="font-weight:bold; text-align:left;">â–¼ å…¨ä½“é›†è¨ˆ</td></tr>';

      const renderRow = (label, obj, prefix = '') => {
        let h = '';
        Object.keys(obj).forEach(rate => {
          if (obj[rate] > 0) {
            h += `<tr><td style="text-align:left;">${prefix}${label}</td><td>${rate}%</td><td style="font-weight:bold;">Â¥${obj[rate].toLocaleString()}</td></tr>`;
          }
        });
        return h;
      };

      invHtml += renderRow('é©æ ¼(ã‚ã‚Š)', inv.total.withInvoice);
      invHtml += renderRow('é©æ ¼(ãªã—)', inv.total.withoutInvoice);
      invHtml += renderRow('ä¸æ˜', inv.total.unknown);

      // --- ç§‘ç›®åˆ¥ ---
      if (inv.bySubject) {
        Object.keys(inv.bySubject).sort().forEach(sub => {
          const sObj = inv.bySubject[sub];
          let hasData = false;
          ['withInvoice', 'withoutInvoice', 'unknown'].forEach(k => {
            Object.values(sObj[k]).forEach(v => { if (v > 0) hasData = true; });
          });

          if (hasData) {
            invHtml += `<tr style="background:#f8fafc;"><td colspan="4" style="font-weight:bold; text-align:left; color:#1e293b;">â–¼ ${sub}</td></tr>`;
            invHtml += renderRow('é©æ ¼(ã‚ã‚Š)', sObj.withInvoice, 'ã€€');
            invHtml += renderRow('é©æ ¼(ãªã—)', sObj.withoutInvoice, 'ã€€');
            invHtml += renderRow('ä¸æ˜', sObj.unknown, 'ã€€');
          }
        });
      }

      if (invHtml === '') invHtml = '<tr><td colspan="3" style="text-align:center; color:#94a3b8;">ãƒ‡ãƒ¼ã‚¿ãªã—</td></tr>';
      invBody.innerHTML = invHtml;
    }

    function loadDailyReport() {
      const m = document.getElementById('dailyReportMonthPicker').value;
      if (!m) return;
      const b = document.getElementById('dailyReportBranchFilter') ? document.getElementById('dailyReportBranchFilter').value : '';
      const el = document.getElementById('dailyPersonList');
      el.innerHTML = '<div style="text-align:center;">èª­ã¿è¾¼ã¿ä¸­...</div>';

      google.script.run.withSuccessHandler(res => {
        if (res.list.length === 0) {
          el.innerHTML = '<div style="text-align:center; color:#94a3b8;">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>';
          return;
        }
        el.innerHTML = res.list.map(p => `
          <div style="background:white; padding:16px; border-radius:12px; display:flex; justify-content:space-between; align-items:center; box-shadow:0 2px 4px rgba(0,0,0,0.05);">
            <div style="font-weight:bold; font-size:1.1rem;">${p.name}</div>
            <div style="font-weight:900; font-size:1.3rem; color:#059669;">Â¥${p.total.toLocaleString()}</div>
          </div>
        `).join('');
      }).withFailureHandler(e => {
        el.innerHTML = 'ã‚¨ãƒ©ãƒ¼';
        showToast(e.message, 'error');
      }).api_getDailyReport(m, b);
    }
    function normalize(s) { return String(s || '').trim().toLowerCase(); }

    // ========== ãƒ¦ãƒ¼ã‚¶ãƒ¼æ©Ÿèƒ½ ==========
    function openCamera() { document.getElementById('rFile').click(); }

    function handleFile(input) {
      if (!input.files[0]) return;
      const file = input.files[0];
      const id = Date.now();
      const isContinueMode = document.getElementById('continueMode').checked;

      const reader = new FileReader();
      reader.onload = e => {
        const dataUrl = e.target.result;

        // ç¶šããƒ¢ãƒ¼ãƒ‰ã®å ´åˆã€æœ€å¾Œã®æ˜ç´°ã«è¿½åŠ 
        if (isContinueMode && cartItems.length > 0) {
          const lastItem = cartItems[cartItems.length - 1];

          // ç”»åƒã‚’é…åˆ—ã§ä¿æŒï¼ˆåˆå›ã¯é…åˆ—åŒ–ï¼‰
          if (!Array.isArray(lastItem.imgData)) {
            lastItem.imgData = [lastItem.imgData];
          }
          lastItem.imgData.push(dataUrl);

          lastItem.status = 'analyzing';
          renderCart();
          showToast('ç¶šãã‚’è§£æä¸­...');

          const base64 = dataUrl.split(',')[1];
          const mimeType = dataUrl.substring(dataUrl.indexOf(':') + 1, dataUrl.indexOf(';'));

          google.script.run.withSuccessHandler(res => {
            lastItem.status = 'done';
            lastItem.amount += res.ocr.amount; // é‡‘é¡ã‚’åŠ ç®—

            // receiptUrlã‚‚é…åˆ—ã§ä¿æŒ
            if (!Array.isArray(lastItem.receiptUrl)) {
              lastItem.receiptUrl = [lastItem.receiptUrl];
            }
            lastItem.receiptUrl.push(res.receiptUrl);

            renderCart();
            showToast('ç¶šãã‚’è¿½åŠ : +Â¥' + res.ocr.amount.toLocaleString());
            document.getElementById('continueMode').checked = false; // ãƒã‚§ãƒƒã‚¯ã‚’å¤–ã™
          }).withFailureHandler(e => {
            lastItem.status = 'error';
            renderCart();
            showToast('è§£æå¤±æ•—: æ‰‹å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
          }).uploadReceiptForOcr(base64, mimeType);

        } else {
          // é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ï¼šæ–°ã—ã„æ˜ç´°ã‚’ä½œæˆ
          const today = new Date().toISOString().split('T')[0];
          const item = { id: id, status: 'analyzing', amount: 0, vendor: '', subject: '', invoiceReg: 'ä¸æ˜', taxRate: 10, usageDate: today, purpose: '', imgData: dataUrl, receiptUrl: null };
          cartItems.push(item);
          renderCart();
          showToast('è§£æã‚’é–‹å§‹ã—ã¾ã—ãŸ');

          const base64 = dataUrl.split(',')[1];
          const mimeType = dataUrl.substring(dataUrl.indexOf(':') + 1, dataUrl.indexOf(';'));

          google.script.run.withSuccessHandler(res => {
            const target = cartItems.find(i => i.id === id);
            if (target) {
              target.status = 'done';
              target.amount = res.ocr.amount;
              target.vendor = res.ocr.vendor;
              target.subject = res.ocr.subject;
              target.invoiceReg = res.ocr.invoiceReg || 'ä¸æ˜';
              target.taxRate = res.ocr.taxRate || 10;
              target.usageDate = res.ocr.date || today;
              target.receiptUrl = res.receiptUrl;
              renderCart();
              showToast('è§£æå®Œäº†: ' + (target.vendor || 'åº—åä¸æ˜'));
            }
          }).withFailureHandler(e => {
            const target = cartItems.find(i => i.id === id);
            if (target) {
              target.status = 'error';
              renderCart();
              showToast('è§£æå¤±æ•—: æ‰‹å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
            }
          }).uploadReceiptForOcr(base64, mimeType);
        }

        setTimeout(() => { document.getElementById('rFile').value = ''; }, 500);
      };
      reader.readAsDataURL(file);
    }

    function renderCart() {
      const list = document.getElementById('cartList');
      list.innerHTML = '';
      let total = 0;

      // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰è¡¨ç¤º
      if (editingAppId) {
        const warning = document.createElement('div');
        warning.innerHTML = `<div style="background:#fff7ed; color:#c2410c; padding:8px 12px; margin-bottom:12px; border-radius:8px; font-size:0.9rem; display:flex; justify-content:space-between; align-items:center;">
          <span>ğŸ“ éå»ã®ç”³è«‹ã‚’ç·¨é›†ä¸­</span>
          <button onclick="cancelEditMode()" style="background:none; border:1px solid #c2410c; border-radius:4px; color:#c2410c; padding:2px 8px; font-size:0.75rem;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>`;
        list.appendChild(warning);
      }

      if (cartItems.length === 0) {
        list.innerHTML += '<div class="cart-empty">ãƒ¬ã‚·ãƒ¼ãƒˆã‚’æ’®å½±ã—ã¦ãã ã•ã„</div>';
        document.getElementById('totalDisplay').innerText = '0';
        document.getElementById('submitBtn').disabled = true;
        const btnInner = document.getElementById('submitBtnText');
        if (btnInner) btnInner.innerText = 'ã¾ã¨ã‚ã¦ç”³è«‹';
        return;
      }

      cartItems.forEach((item) => {
        total += Number(item.amount || 0);
        const div = document.createElement('div');
        div.className = 'cart-item';
        div.onclick = (e) => {
          if (!e.target.closest('.cart-del-btn')) openEdit(item.id);
        };

        let overlay = item.status === 'analyzing' ? `<div class="analyzing-overlay"><div class="mini-spinner"></div></div>` : '';
        let amtClass = item.amount > 0 ? 'cart-amount' : 'cart-amount zero';
        let amtText = item.amount > 0 ? `Â¥${item.amount.toLocaleString()}` : 'Â¥ -';
        let statusText = item.status === 'analyzing' ? 'è§£æä¸­...' : (item.vendor || 'åº—åä¸æ˜');

        // ç”»åƒè¡¨ç¤ºãƒ­ã‚¸ãƒƒã‚¯ (ç·¨é›†æ™‚ã®receiptUrlå¯¾å¿œå¼·åŒ–)
        let imgHtml = '';
        const hasImgData = item.imgData && (Array.isArray(item.imgData) ? item.imgData.length > 0 : item.imgData);
        const hasUrl = item.receiptUrl && (Array.isArray(item.receiptUrl) ? item.receiptUrl.length > 0 : item.receiptUrl);

        if (hasImgData) {
          // æ–°è¦è¿½åŠ ä¸­ã®ç”»åƒ (Base64)
          const imgSrc = Array.isArray(item.imgData) ? item.imgData[0] : item.imgData;
          const imgCount = Array.isArray(item.imgData) ? item.imgData.length : 1;
          const badge = imgCount > 1 ? `<div style="position:absolute; top:4px; right:4px; background:#3b82f6; color:white; border-radius:8px; padding:2px 8px; font-size:0.8rem; font-weight:700;">Ã—${imgCount}</div>` : '';
          imgHtml = `<img src="${imgSrc}" class="cart-thumb">${badge}`;
        } else if (hasUrl) {
          // ã‚µãƒ¼ãƒãƒ¼ä¿å­˜æ¸ˆç”»åƒ (ç·¨é›†ãƒ¢ãƒ¼ãƒ‰)
          const urls = Array.isArray(item.receiptUrl) ? item.receiptUrl : [item.receiptUrl];
          const count = urls.length;
          // æœ€åˆã®ç”»åƒã®IDã‚’å–å¾—ã—ã¦ã‚µãƒ ãƒã‚¤ãƒ«è¡¨ç¤ºã‚’è©¦ã¿ã‚‹
          let firstId = null;
          const m = urls[0].match(/id=([a-zA-Z0-9_-]+)/) || urls[0].match(/\/d\/([a-zA-Z0-9_-]+)/);
          if (m) firstId = m[1];

          if (firstId) {
            const imgId = 'cart-img-' + item.id;
            imgHtml = `<div class="cart-thumb" style="overflow:hidden; position:relative;">
                <img id="${imgId}" style="width:100%; height:100%; object-fit:cover;" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7">
                <div style="position:absolute; top:4px; right:4px; background:#64748b; color:white; border-radius:8px; padding:2px 8px; font-size:0.8rem;">ä¿å­˜æ¸ˆÃ—${count}</div>
             </div>`;
            setTimeout(() => loadOneImage(firstId, imgId), 10);
          } else {
            imgHtml = `<div class="cart-thumb" style="background:#f1f5f9; display:flex; align-items:center; justify-content:center; color:#64748b; font-size:0.8rem; font-weight:bold;"><span>ğŸ“· æ¸ˆÃ—${count}</span></div>`;
          }
        } else {
          imgHtml = `<div class="cart-thumb" style="background:#f1f5f9;"></div>`;
        }

        div.innerHTML = `
        <div class="cart-item-header">
          <div class="cart-thumb-box">
            ${imgHtml}
            ${overlay}
          </div>
          <div class="cart-item-content">
            <div class="cart-info">
              <div class="cart-meta">${item.subject ? `<span class="status-badge">${item.subject}</span>` : ''}</div>
              <div class="cart-vendor">${statusText}</div>
            </div>
          </div>
        </div>
        <div class="cart-item-actions">
          <div class="${amtClass}">${amtText}</div>
          <button class="cart-del-btn" onclick="event.stopPropagation(); delCart(${item.id})">
            <span>ğŸ—‘ï¸</span> å‰Šé™¤
          </button>
        </div>
      `;
        list.appendChild(div);
      });
      document.getElementById('totalDisplay').textContent = total.toLocaleString();
      document.getElementById('submitBtn').disabled = false;

      const btnInner = document.getElementById('submitBtnText');
      if (btnInner) {
        btnInner.innerText = editingAppId ? 'æ›´æ–°ã—ã¦å†ç”³è«‹' : 'ã¾ã¨ã‚ã¦ç”³è«‹';
      }
    }

    function delCart(id) {
      if (!confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
      cartItems = cartItems.filter(i => i.id !== id);
      renderCart();
    }

    function openEdit(id) {
      const item = cartItems.find(i => i.id === id);
      if (!item) return;
      editingId = id;

      // è¤‡æ•°ç”»åƒã«å¯¾å¿œ
      const imgBox = document.querySelector('.edit-img-box');
      imgBox.innerHTML = '';
      if (Array.isArray(item.imgData)) {
        item.imgData.forEach((img, idx) => {
          const imgEl = document.createElement('img');
          imgEl.src = img;
          imgEl.className = 'edit-img';
          imgEl.style.marginBottom = idx < item.imgData.length - 1 ? '12px' : '0';
          imgBox.appendChild(imgEl);
        });
      } else {
        const imgEl = document.createElement('img');
        imgEl.src = item.imgData;
        imgEl.className = 'edit-img';
        imgBox.appendChild(imgEl);
      }

      document.getElementById('eDate').value = item.usageDate || new Date().toISOString().split('T')[0];
      document.getElementById('eAmt').value = item.amount || '';
      document.getElementById('eTax').value = item.taxRate || 10;
      document.getElementById('eVen').value = item.vendor || '';
      document.getElementById('eSub').value = item.subject || '';
      document.getElementById('ePurpose').value = item.purpose || '';
      document.getElementById('editModal').style.display = 'flex';
    }

    function saveEdit() {
      const item = cartItems.find(i => i.id === editingId);
      if (item) {
        item.usageDate = document.getElementById('eDate').value;
        item.amount = Number(document.getElementById('eAmt').value);
        item.taxRate = Number(document.getElementById('eTax').value);
        item.vendor = document.getElementById('eVen').value;
        item.subject = document.getElementById('eSub').value;
        item.purpose = document.getElementById('ePurpose').value;
        if (item.status !== 'analyzing') item.status = 'done';
      }
      renderCart();
      document.getElementById('editModal').style.display = 'none';
    }

    // ç§‘ç›®å¤‰æ›´æ™‚ã«ç¨ç‡ã‚’è‡ªå‹•æ›´æ–°
    function updateTaxRateBySubject() {
      const subjectName = document.getElementById('eSub').value;
      const subjectData = subjectMasterWithTax.find(s => s.name === subjectName);
      if (subjectData) {
        document.getElementById('eTax').value = subjectData.taxRate;
      }
    }
    function closeEdit() { document.getElementById('editModal').style.display = 'none'; }

    function submitCart() {
      if (cartItems.length === 0) return;
      const invalid = cartItems.some(i => !i.amount || i.amount <= 0);
      if (invalid) return showToast('é‡‘é¡ãŒæœªå…¥åŠ›ã®æ˜ç´°ãŒã‚ã‚Šã¾ã™ï¼', 'error');
      const analyzing = cartItems.some(i => i.status === 'analyzing');
      if (analyzing) return showToast('è§£æä¸­ã®æ˜ç´°ãŒã‚ã‚Šã¾ã™', 'error');

      const isUpdate = !!editingAppId;
      const msg = isUpdate
        ? `ä¿®æ­£å†…å®¹ã§æ›´æ–°ï¼ˆå†ç”³è«‹ï¼‰ã—ã¾ã™ã‹ï¼Ÿ\nåˆè¨ˆ Â¥${document.getElementById('totalDisplay').innerText}`
        : `åˆè¨ˆ Â¥${document.getElementById('totalDisplay').innerText} ã§ç”³è«‹ã—ã¾ã™ã‹ï¼Ÿ`;

      if (!confirm(msg)) return;

      const applicantId = document.getElementById('applicantSelector').value;
      const data = { applicantId: applicantId, items: cartItems };

      showLoad(isUpdate ? 'æ›´æ–°ä¸­...' : 'ç”³è«‹é€ä¿¡ä¸­...');

      const successHandler = (res) => {
        hideLoad();
        showToast(isUpdate ? 'æ›´æ–°ã—ã¾ã—ãŸï¼' : 'ç”³è«‹ãŒå®Œäº†ã—ã¾ã—ãŸï¼');
        cartItems = [];
        editingAppId = null;
        renderCart();
      };
      const failureHandler = (e) => {
        hideLoad(); showToast('ã‚¨ãƒ©ãƒ¼: ' + e.message, 'error');
      };

      if (isUpdate) {
        google.script.run.withSuccessHandler(successHandler).withFailureHandler(failureHandler).api_updateApplication(editingAppId, data);
      } else {
        google.script.run.withSuccessHandler(successHandler).withFailureHandler(failureHandler).createApplicationWithDetails(data);
      }
    }

    // ========== ç®¡ç†è€…æ©Ÿèƒ½ ==========
    function toggleMode() {
      const btn = document.getElementById('adminBtn');
      if (!isAdminMode) {
        isAdminMode = true;
        document.getElementById('userView').classList.remove('active');
        document.getElementById('adminView').classList.add('active');
        btn.innerText = 'ç”³è«‹ã¸';
        loadAdminData();
      } else {
        isAdminMode = false;
        document.getElementById('adminView').classList.remove('active');
        document.getElementById('userView').classList.add('active');
        btn.innerText = 'ç®¡ç†è€…';
      }
    }

    function loadAdminData() {
      showLoad('ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­...');
      google.script.run.withSuccessHandler(res => {
        hideLoad();
        // res.subjectList ã¯ Object Array ({name, taxRate...})

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã‚’æ›´æ–°
        subjectMasterWithTax = res.subjectList;
        subjectMaster = res.subjectList.map(s => s.name);

        allPendingList = res.pendingList;
        populateApplicantFilter(res.pendingList);
        populateBranchFilter(res.branches || []); // â˜…å‹•çš„ã«æ‹ ç‚¹ãƒ•ã‚£ãƒ«ã‚¿ã‚’æ›´æ–°
        renderAdminCards(res.pendingList);
      }).withFailureHandler(e => {
        hideLoad(); showToast('å–å¾—å¤±æ•—: ' + e.message, 'error');
      }).getAdminDashboardData();
    }

    /**
     * å„ç¨®ãƒ¬ãƒãƒ¼ãƒˆç”»é¢ã®æ‹ ç‚¹ãƒ•ã‚£ãƒ«ã‚¿ã‚’ç”Ÿæˆ
     */
    function populateBranchFilter(branches) {
      const ids = ['reportBranchFilter', 'dailyReportBranchFilter', 'depBranch'];
      ids.forEach(id => {
        const sel = document.getElementById(id);
        if (!sel) return;
        const currentVal = sel.value;
        sel.innerHTML = (id === 'depBranch' ? '<option value="">æŒ‡å®šãªã—</option>' : '<option value="">å…¨æ‹ ç‚¹</option>');
        branches.forEach(b => {
          const op = document.createElement('option');
          op.value = b; op.text = b;
          sel.appendChild(op);
        });
        sel.value = currentVal;
      });
    }

    // XSSå¯¾ç­–: HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—é–¢æ•°
    function escapeHtml(str) {
      if (typeof str !== 'string') return str;
      return str.replace(/[&<>"']/g, function (match) {
        return {
          '&': '&amp;',
          '<': '&lt;',
          '>': '&gt;',
          '"': '&quot;',
          "'": '&#39;'
        }[match];
      });
    }

    // å…±é€šã‚«ãƒ¼ãƒ‰ç”Ÿæˆé–¢æ•° (AdminCardã¨PaymentCardã§åˆ©ç”¨)
    function createAdminCardElement(app, duplicateMap) {
      const card = document.createElement('div');
      card.className = 'admin-card';
      card.id = 'card-' + app.appId;

      const hasDuplicates = app.details.some(detail => {
        const key = `${app.applicant}_${detail.vendor}_${detail.amount}`;
        return duplicateMap && duplicateMap[key] && duplicateMap[key].length > 1;
      });

      if (hasDuplicates) {
        card.classList.add('duplicate-warning');
      }

      const safeApplicant = escapeHtml(app.applicant);
      const safeDept = escapeHtml(app.dept || '-');
      const safeDate = escapeHtml(app.date || app.approvedAt);

      const head = `
        <div class="ac-header">
          <div>
            <div class="ac-user">${safeApplicant} <span class="ac-dept">${safeDept}</span></div>
            <div style="font-size:0.8rem; color:#64748b;">${safeDate}</div>
          </div>
          <div class="ac-total">Â¥${Number(app.totalAmount).toLocaleString()}</div>
        </div>
      `;

      let bodyHtml = '<div class="ac-body" style="display:flex; flex-wrap:wrap; gap:8px;">';
      app.details.forEach(d => {
        let subOpts = `<option value="" ${!d.subject ? 'selected' : ''}>--æœªé¸æŠ--</option>` +
          subjectMaster.map(s => {
            const safeS = escapeHtml(s);
            return `<option value="${safeS}" ${s === d.subject ? 'selected' : ''}>${safeS}</option>`;
          }).join('');

        const imgId = `img-${d.detailId}`;
        const detailKey = `${app.applicant}_${d.vendor}_${d.amount}`;
        const isDuplicate = duplicateMap && duplicateMap[detailKey] && duplicateMap[detailKey].length > 1;

        const invOpts = ['ã‚ã‚Š', 'ãªã—', 'ä¸æ˜'].map(v =>
          `<option value="${v}" ${v === (d.invoiceReg || 'ä¸æ˜') ? 'selected' : ''}>${v}</option>`
        ).join('');

        const taxOpts = [10, 8].map(t =>
          `<option value="${t}" ${t === (d.taxRate || 10) ? 'selected' : ''}>${t}%</option>`
        ).join('');

        const safeVendor = escapeHtml(d.vendor || '');
        const safePurpose = escapeHtml(d.purpose || '');

        bodyHtml += `
          <div class="detail-item" id="det-${d.detailId}" ${isDuplicate ? 'style="background: linear-gradient(135deg, #fef2f2, #fee2e2); border-left: 4px solid #ef4444; padding: 12px 0 12px 12px; box-sizing: border-box;"' : ''}>
            ${isDuplicate ? '<div style="font-size: 0.8rem; color: #dc2626; font-weight: 700; margin-bottom: 8px;">âš ï¸ é‡è¤‡ã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™</div>' : ''}
            <div class="d-row">
              <div class="d-thumb-box" onclick="zoomImage('${imgId}')">
                <img id="${imgId}" class="d-thumb" style="width:100%; height:100%; object-fit:cover;" src="" data-file-id="${d.fileId || ''}">
                ${(!d.hasImage) ? '<div style="font-size:0.6rem; color:#ccc; text-align:center; margin-top:16px;">No Image</div>' : ''}
              </div>
              <div class="d-inputs">
                <div class="input-group-compact span-full">
                  <label>åˆ©ç”¨æ—¥</label>
                  <input type="date" class="d-date" value="${d.usageDate || ''}">
                </div>
                <div class="input-group-compact span-full">
                  <label>åº—å</label>
                  <input type="text" class="d-vendor" value="${safeVendor}" placeholder="åº—å">
                </div>
                <div class="input-group-compact">
                  <label>é‡‘é¡ï¼ˆå††ï¼‰</label>
                  <input type="number" class="d-amount" value="${d.amount}" placeholder="é‡‘é¡">
                </div>
                <div class="input-group-compact">
                  <label>ç¨ç‡</label>
                  <select class="d-taxrate">${taxOpts}</select>
                </div>
                <div class="input-group-compact">
                  <label>ç§‘ç›®</label>
                  <select class="d-subject">${subOpts}</select>
                </div>
                <div class="input-group-compact">
                  <label>ã‚¤ãƒ³ãƒœã‚¤ã‚¹ç™»éŒ²</label>
                  <select class="d-invoice">${invOpts}</select>
                </div>
                <div class="input-group-compact span-full">
                  <label>å‚™è€ƒãƒ»åˆ©ç”¨ç›®çš„</label>
                  <textarea class="d-purpose" placeholder="ä¼šè­°è²»ã€æ¥å¾…ãªã©" rows="1">${safePurpose}</textarea>
                </div>
              </div>
            </div>
          </div>
        `;
      });
      bodyHtml += '</div>';

      card.innerHTML = head + bodyHtml;

      const foot = document.createElement('div');
      foot.className = 'ac-footer';

      const btnRj = document.createElement('button');
      btnRj.className = 'btn-rj';
      btnRj.innerText = 'å´ä¸‹';
      btnRj.onclick = function () { openConfirm(app.appId, 'reject'); };

      const btnRt = document.createElement('button');
      btnRt.className = 'btn-rt';
      btnRt.innerText = 'å·®ã—æˆ»ã—';
      btnRt.onclick = function () { openReturnModal(app.appId); };

      const btnAp = document.createElement('button');
      btnAp.className = 'btn-ap';
      btnAp.innerText = 'æ‰¿èª';
      btnAp.onclick = function () { openConfirm(app.appId, 'approve'); };

      foot.appendChild(btnRj);
      foot.appendChild(btnRt);
      foot.appendChild(btnAp);
      card.appendChild(foot);

      return card;
    }


    function renderAdminCards(list) {
      const con = document.getElementById('cardContainer');
      con.innerHTML = '';
      if (!list || list.length === 0) {
        con.innerHTML = `
          <div style="color:white; margin:auto; text-align:center; font-size:1.2rem; font-weight:600; opacity:0.8;">
          <div style="font-size:3rem; margin-bottom:16px;">âœ…</div>
          <div>æ‰¿èªå¾…ã¡ã®ç”³è«‹ã¯ã‚ã‚Šã¾ã›ã‚“</div>
          <div style="font-size:1rem; margin-top:8px; opacity:0.6;">å…¨ã¦ã®ç”³è«‹ãŒå‡¦ç†æ¸ˆã¿ã§ã™</div>
          </div>
          `;
        return;
      }

      // é‡è¤‡ãƒã‚§ãƒƒã‚¯ç”¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’æº–å‚™
      const duplicateMap = {};
      list.forEach(app => {
        app.details.forEach(detail => {
          const key = `${app.applicant}_${detail.vendor}_${detail.amount} `;
          if (!duplicateMap[key]) {
            duplicateMap[key] = [];
          }
          duplicateMap[key].push({ appId: app.appId, detailId: detail.detailId });
        });
      });

      // ç”»åƒä¸€æ‹¬å–å¾—ç”¨ãƒªã‚¹ãƒˆ
      const allFileIds = [];

      list.forEach(app => {
        // Collect Image IDs
        app.details.forEach(d => {
          if (d.hasImage && d.fileId) allFileIds.push(d.fileId);
        });

        const card = createAdminCardElement(app, duplicateMap);
        con.appendChild(card);
      });

      // ç”»åƒä¸€æ‹¬å–å¾—
      if (allFileIds.length > 0) {
        google.script.run.withSuccessHandler(imgMap => {
          Object.keys(imgMap).forEach(fid => {
            const b64 = imgMap[fid];
            const targets = document.querySelectorAll(`img[data-file-id="${fid}"]`);
            targets.forEach(img => {
              if (b64) {
                img.src = b64;
              } else {
                // ã‚¨ãƒ©ãƒ¼æ™‚
                img.parentNode.innerHTML = '<div style="width:100%; height:100%; background:#f1f5f9; display:flex; justify-content:center; align-items:center; color:#ef4444; font-size:0.8rem;">èª­è¾¼ã‚¨ãƒ©ãƒ¼</div>';
              }
            });
          });
        }).api_getImagesBatch(allFileIds);
      }
    }

    function loadOneImage(fileId, imgDomId) {
      google.script.run.withSuccessHandler(b64 => {
        const img = document.getElementById(imgDomId);
        if (!img) return;
        if (b64) {
          img.src = b64;
        } else {
          // èª­ã¿è¾¼ã¿å¤±æ•—æ™‚ã®ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼
          img.parentNode.innerHTML = '<div style="width:100%; height:100%; background:#f1f5f9; display:flex; justify-content:center; align-items:center; color:#94a3b8; font-size:0.8rem;">ç”»åƒãªã—</div>';
        }
      }).withFailureHandler(e => {
        const img = document.getElementById(imgDomId);
        if (img) img.parentNode.innerHTML = '<div style="width:100%; height:100%; background:#f1f5f9; display:flex; justify-content:center; align-items:center; color:#ef4444; font-size:0.8rem;">èª­è¾¼ã‚¨ãƒ©ãƒ¼</div>';
      }).api_getReceiptImage(fileId);
    }

    function openConfirm(appId, action) {
      pendingAppId = appId;
      pendingAction = action;
      const msg = action === 'approve' ? 'ã“ã®å†…å®¹ã§æ‰¿èªã—ã¾ã™ã‹ï¼Ÿ' : 'å´ä¸‹ã—ã¾ã™ã‹ï¼Ÿ';
      document.getElementById('confirmMsg').innerText = msg;
      const yesBtn = document.getElementById('confirmYesBtn');
      yesBtn.onclick = function () { execProcess(); };
      document.getElementById('confirmToast').style.display = 'flex';
    }

    function closeConfirm() {
      document.getElementById('confirmToast').style.display = 'none';
      pendingAppId = null;
      pendingAction = null;
    }

    function execProcess() {
      const appId = pendingAppId;
      const action = pendingAction;
      closeConfirm();

      const card = document.getElementById('card-' + appId);
      const details = [];
      card.querySelectorAll('.detail-item').forEach(row => {
        const dId = row.id.replace('det-', '');
        const date = row.querySelector('.d-date').value;
        const sub = row.querySelector('.d-subject').value;
        const ven = row.querySelector('.d-vendor').value;
        const amt = row.querySelector('.d-amount').value;
        const tax = row.querySelector('.d-taxrate').value;
        const inv = row.querySelector('.d-invoice').value;
        const pur = row.querySelector('.d-purpose').value;
        details.push({ detailId: dId, usageDate: date, subject: sub, vendor: ven, amount: amt, taxRate: tax, invoiceReg: inv, purpose: pur });
      });

      card.style.transition = 'opacity 0.3s, transform 0.3s';
      card.style.opacity = '0';
      card.style.transform = 'translateY(-20px)';
      setTimeout(() => card.remove(), 300);

      google.script.run.withSuccessHandler(() => {
        showToast('å‡¦ç†å®Œäº†');
        if (typeof closeHistoryEdit === 'function') closeHistoryEdit();
      }).withFailureHandler(e => {
        showToast('ã‚¨ãƒ©ãƒ¼: ' + e.message, 'error');
      }).processApplicationWithEdit(appId, action, details);
    }

    function openReturnModal(appId) {
      pendingAppId = appId;
      document.getElementById('returnComment').value = '';
      document.getElementById('returnModal').style.display = 'flex';
    }

    function closeReturnModal() {
      document.getElementById('returnModal').style.display = 'none';
      pendingAppId = null;
    }

    function execReturn() {
      const appId = pendingAppId;
      const comment = document.getElementById('returnComment').value;
      closeReturnModal();

      const card = document.getElementById('card-' + appId);
      const details = [];
      card.querySelectorAll('.detail-item').forEach(row => {
        const dId = row.id.replace('det-', '');
        const date = row.querySelector('.d-date').value;
        const sub = row.querySelector('.d-subject').value;
        const ven = row.querySelector('.d-vendor').value;
        const amt = row.querySelector('.d-amount').value;
        const tax = row.querySelector('.d-taxrate').value;
        const inv = row.querySelector('.d-invoice').value;
        const pur = row.querySelector('.d-purpose').value;
        details.push({ detailId: dId, usageDate: date, subject: sub, vendor: ven, amount: amt, taxRate: tax, invoiceReg: inv, purpose: pur });
      });

      card.style.transform = 'translateY(-20px)';
      setTimeout(() => card.remove(), 300);

      google.script.run.withSuccessHandler(() => {
        showToast('å·®ã—æˆ»ã—ã‚’å®Ÿè¡Œã—ã¾ã—ãŸ');
        if (typeof closeHistoryEdit === 'function') closeHistoryEdit();
      }).withFailureHandler(e => {
        showToast('ã‚¨ãƒ©ãƒ¼: ' + e.message, 'error');
      }).processReturn(appId, comment, details);
    }

    // ç”»åƒæ‹¡å¤§è¡¨ç¤º (ä¿®æ­£)
    function zoomImage(imgIdOrElementId) {
      const img = document.getElementById(imgIdOrElementId);
      if (img && img.src) {
        document.getElementById('zoomImg').src = img.src;
        document.getElementById('imageModal').style.display = 'flex';
      }
    }

    // ç§‘ç›®ãƒã‚¹ã‚¿
    // ç§‘ç›®ãƒã‚¹ã‚¿
    let editingSubjectName = null;

    function openSubjectMaster() {
      // ä¸€è¦§æç”»ã¯ loadAdminData ã§å–å¾—æ¸ˆã¿ assuming subjectMasterWithTax has the data
      renderSubjectList();
      resetSubjectInputs();
      document.getElementById('subjectModal').style.display = 'flex';
    }

    function closeSubjectMaster() {
      document.getElementById('subjectModal').style.display = 'none';
      resetSubjectInputs();
    }

    function resetSubjectInputs() {
      document.getElementById('newSubject').value = '';
      document.getElementById('newTax').value = '10';
      document.getElementById('newKw').value = '';
      editingSubjectName = null;
      document.getElementById('updateSubBtn').style.display = 'none';
      document.getElementById('addSubBtn').style.display = 'inline-block';
    }

    function renderSubjectList() {
      const div = document.getElementById('subjectListDiv');
      // subjectMasterWithTax ã¯ {name, taxRate, keywords} ã®é…åˆ—ãŒå…¥ã£ã¦ã„ã‚‹å‰æ
      // loadAdminData ã§ res.subjectList (ã“ã‚Œã¯ä»¥å‰ã¯åå‰é…åˆ—ã ã£ãŸãŒã€Objecté…åˆ—ã«ãªã£ãŸ) ã‚’å—ã‘å–ã‚‹å¿…è¦ãŒã‚ã‚‹
      const list = subjectMasterWithTax; // initDataã‚„loadAdminDataã§æ›´æ–°ã•ã‚Œã‚‹

      if (!list || list.length === 0) {
        div.innerHTML = '<div style="color:#94a3b8; text-align:center;">ãªã—</div>';
        return;
      }

      div.innerHTML = list.map(s => {
        // s ãŒæ–‡å­—åˆ—ã®å ´åˆï¼ˆå¤ã„ãƒ‡ãƒ¼ã‚¿äº’æ›ï¼‰ã¨ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å ´åˆã‚’è€ƒæ…®
        const name = s.name || s;
        const tax = s.taxRate || 10;
        return `< div class="master-item" >
            <div style="flex:1;">
                <div style="font-weight:bold;">${name}</div>
                <div style="font-size:0.8rem; color:#64748b;">ç¨ç‡: ${tax}%</div>
            </div>
            <button onclick="startEditSubject('${name}', ${tax}, '${s.keywords || ''}')" style="margin-right:8px; padding:4px 8px; border:1px solid #cbd5e1; background:white; border-radius:4px;">ç·¨é›†</button>
            <span class="del-sub" onclick="delSubject('${name}')" style="color:red; cursor:pointer; padding:4px;">âœ•</span>
          </div > `;
      }).join('');
    }

    function startEditSubject(name, tax, kw) {
      editingSubjectName = name;
      document.getElementById('newSubject').value = name;
      document.getElementById('newTax').value = tax;
      document.getElementById('newKw').value = kw;
      document.getElementById('updateSubBtn').style.display = 'inline-block';
      document.getElementById('addSubBtn').style.display = 'none';
    }

    function addSubject() {
      const name = document.getElementById('newSubject').value;
      const tax = document.getElementById('newTax').value;
      const kw = document.getElementById('newKw').value;
      if (!name) return;

      google.script.run.withSuccessHandler(list => {
        // è¿”å´å€¤ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«åæ˜ 
        updateSubjectGlobal(list);
        renderSubjectList();
        resetSubjectInputs();
      }).api_addSubject(name, tax, kw);
    }

    function updateSubject() {
      if (!editingSubjectName) return;
      const name = document.getElementById('newSubject').value;
      const tax = document.getElementById('newTax').value;
      const kw = document.getElementById('newKw').value;

      google.script.run.withSuccessHandler(list => {
        updateSubjectGlobal(list);
        renderSubjectList();
        resetSubjectInputs();
      }).api_updateSubject(editingSubjectName, name, tax, kw);
    }

    function delSubject(val) {
      if (!confirm(`ç§‘ç›®ã€Œ${val}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;
      google.script.run.withSuccessHandler(list => {
        updateSubjectGlobal(list);
        renderSubjectList();
      }).api_deleteSubject(val);
    }

    function updateSubjectGlobal(list) {
      // ãƒªã‚¹ãƒˆã¯ {name, taxRate, keywords} ã®é…åˆ—
      subjectMasterWithTax = list;
      // å˜ç´”ãªåå‰ãƒªã‚¹ãƒˆã‚‚æ›´æ–°ã—ã¦ãŠãï¼ˆäº’æ›æ€§ï¼‰
      subjectMaster = list.map(s => s.name);
    }

    function showLoad(txt) { document.getElementById('loadText').innerText = txt; document.getElementById('loadingOverlay').style.display = 'flex'; }
    function hideLoad() { document.getElementById('loadingOverlay').style.display = 'none'; }
    function showToast(msg, type = 'normal') {
      const t = document.getElementById('toast'); t.innerText = msg;
      t.style.background = type === 'error' ? '#ef4444' : '#1e293b';
      t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 5000);
    }
    function zoomImage(imgId) {
      const src = document.getElementById(imgId).src;
      if (src) { document.getElementById('zoomImg').src = src; document.getElementById('imageModal').style.display = 'flex'; }
    }

    // ========== ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ©Ÿèƒ½ ==========
    function populateApplicantFilter(pendingList) {
      const filter = document.getElementById('applicantFilter');
      const applicants = [...new Set(pendingList.map(app => app.applicant))].sort();

      // æ—¢å­˜ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’å‰Šé™¤ï¼ˆã€Œå…¨ã¦ã®ç”³è«‹è€…ã€ä»¥å¤–ï¼‰
      while (filter.children.length > 1) {
        filter.removeChild(filter.lastChild);
      }

      // ç”³è«‹è€…ãƒªã‚¹ãƒˆã‚’è¿½åŠ 
      applicants.forEach(name => {
        const option = document.createElement('option');
        option.value = name;
        option.textContent = name;
        filter.appendChild(option);
      });

      // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¨­å®š
      filter.onchange = applyApplicantFilter;
    }

    function applyApplicantFilter() {
      const selectedApplicant = document.getElementById('applicantFilter').value;
      const filteredList = selectedApplicant
        ? allPendingList.filter(app => app.applicant === selectedApplicant)
        : allPendingList;

      // åˆè¨ˆé‡‘é¡ã‚’è¨ˆç®—
      const totalAmount = filteredList.reduce((sum, app) => sum + Number(app.totalAmount || 0), 0);

      // åˆè¨ˆé‡‘é¡è¡¨ç¤ºã®æ›´æ–°
      const totalDisplay = document.getElementById('filterTotalDisplay');
      const totalSpan = document.getElementById('filterTotal');

      if (selectedApplicant && filteredList.length > 0) {
        totalSpan.textContent = totalAmount.toLocaleString();
        totalDisplay.style.display = 'block';
      } else {
        totalDisplay.style.display = 'none';
      }

      renderAdminCards(filteredList);
    }

    function showHelp() {
      document.getElementById('helpModal').style.display = 'flex';
    }
    function closeHelp() {
      document.getElementById('helpModal').style.display = 'none';
    }
    // --- å…¥é‡‘ç™»éŒ²ãƒ¢ãƒ¼ãƒ€ãƒ« ---
    function openDepositModal() {
      document.getElementById('depositModal').style.display = 'flex';
      document.getElementById('depDate').value = new Date().toISOString().slice(0, 10);
      document.getElementById('depAmt').value = '';
      document.getElementById('depMemo').value = '';
    }

    function closeDepositModal() {
      document.getElementById('depositModal').style.display = 'none';
    }

    function registerDeposit() {
      const type = document.getElementById('depType').value;
      const date = document.getElementById('depDate').value;
      const amt = document.getElementById('depAmt').value;
      const memo = document.getElementById('depMemo').value;
      const branch = document.getElementById('depBranch').value;

      if (!date || !amt) {
        showToast('æ—¥ä»˜ã¨é‡‘é¡ã¯å¿…é ˆã§ã™', 'error');
        return;
      }

      showLoad('ç™»éŒ²å‡¦ç†ä¸­...');
      google.script.run.withSuccessHandler(res => {
        hideLoad();
        closeDepositModal();
        showToast(type + 'ã‚’ç™»éŒ²ã—ã¾ã—ãŸ');
      }).withFailureHandler(e => {
        hideLoad();
        showToast('ã‚¨ãƒ©ãƒ¼: ' + e.message, 'error');
      }).api_registerDeposit(date, Number(amt), memo, type, branch);
    }

    // ========== æ”¯æ‰•ã„ç®¡ç†æ©Ÿèƒ½ ==========
    function loadPaymentList() {
      const startPicker = document.getElementById('paymentStartDatePicker');
      const endPicker = document.getElementById('paymentEndDatePicker');

      // åˆæœŸå€¤è¨­å®š (æœªå…¥åŠ›ã®å ´åˆã€ä»Šæœˆ1æ—¥ã€œä»Šæ—¥)
      if (!startPicker.value || !endPicker.value) {
        const now = new Date();
        const y = now.getFullYear();
        const m = now.getMonth() + 1;
        const mStr = m < 10 ? '0' + m : m;
        const d = now.getDate();
        const dStr = d < 10 ? '0' + d : d;

        if (!startPicker.value) startPicker.value = `${y}-${mStr}-01`;
        if (!endPicker.value) endPicker.value = `${y}-${mStr}-${dStr}`;
      }

      const sDate = startPicker.value;
      const eDate = endPicker.value;
      const el = document.getElementById('paymentListContainer');
      el.innerHTML = '<div style="text-align:center;">èª­ã¿è¾¼ã¿ä¸­...</div>';

      // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒªã‚»ãƒƒãƒˆ
      document.getElementById('paymentApplicantFilter').value = '';
      document.getElementById('paymentStatusFilter').value = '';
      document.getElementById('paymentSummaryArea').style.display = 'none';

      console.log('Fetching payment list for range:', sDate, 'to', eDate);

      google.script.run.withSuccessHandler(list => {
        console.log('Payment list received:', list);
        lastPaymentList = list; // Store the list globally

        // ç”³è«‹è€…ãƒªã‚¹ãƒˆã‚’å‹•çš„ç”Ÿæˆ
        populatePaymentApplicantFilter(list);

        renderPaymentHistoryCards(list);
        updatePaymentSummary(list);
      }).withFailureHandler(e => {
        console.error('Payment list fetch failed:', e);
        el.innerHTML = 'ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ: ' + e.message;
        showToast(e.message, 'error');
      }).api_getPaymentList(sDate, eDate);
    }

    function populatePaymentApplicantFilter(list) {
      const sel = document.getElementById('paymentApplicantFilter');
      // æ—¢å­˜ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ã‚¯ãƒªã‚¢ (æœ€åˆã®ã€Œå…¨å“¡ã€ã¯æ®‹ã™)
      while (sel.options.length > 1) sel.remove(1);

      // ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªç”³è«‹è€…ã‚’æŠ½å‡º
      const applicants = [...new Set(list.map(a => a.applicant))].sort();
      applicants.forEach(name => {
        const opt = document.createElement('option');
        opt.value = name;
        opt.textContent = name;
        sel.appendChild(opt);
      });
    }

    function filterPaymentList() {
      const applicantFilter = document.getElementById('paymentApplicantFilter').value;
      const statusFilter = document.getElementById('paymentStatusFilter').value;

      // Nullãƒã‚§ãƒƒã‚¯
      if (!lastPaymentList || lastPaymentList.length === 0) {
        renderPaymentHistoryCards([]);
        updatePaymentSummary([], applicantFilter, statusFilter);
        return;
      }

      // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
      let filtered = lastPaymentList.filter(app => {
        if (applicantFilter && app.applicant !== applicantFilter) return false;
        if (statusFilter) {
          const isPaid = (app.paymentStatus === 'æ”¯æ‰•æ¸ˆ');
          if (statusFilter === 'æœªæ‰•ã„' && isPaid) return false;
          if (statusFilter === 'æ”¯æ‰•æ¸ˆ' && !isPaid) return false;
        }
        return true;
      });

      renderPaymentHistoryCards(filtered);
      updatePaymentSummary(filtered, applicantFilter, statusFilter);
    }

    function updatePaymentSummary(list, applicantFilter, statusFilter) {
      const summaryArea = document.getElementById('paymentSummaryArea');
      const labelEl = document.getElementById('paymentSummaryLabel');
      const totalEl = document.getElementById('paymentSummaryTotal');
      const unpaidEl = document.getElementById('paymentSummaryUnpaid');
      const paidEl = document.getElementById('paymentSummaryPaid');
      const countEl = document.getElementById('paymentSummaryCount');

      if (!list || list.length === 0) {
        summaryArea.style.display = 'none';
        return;
      }

      let totalAmount = 0;
      let unpaidAmount = 0;
      let paidAmount = 0;

      list.forEach(app => {
        const amt = Number(app.totalAmount) || 0;
        totalAmount += amt;
        if (app.paymentStatus === 'æ”¯æ‰•æ¸ˆ') {
          paidAmount += amt;
        } else {
          unpaidAmount += amt;
        }
      });

      // ãƒ©ãƒ™ãƒ«ç”Ÿæˆ
      const sDate = document.getElementById('paymentStartDatePicker').value;
      const eDate = document.getElementById('paymentEndDatePicker').value;
      let label = `${sDate} ã€œ ${eDate}`;
      if (applicantFilter) label += ` | ${applicantFilter}`;
      if (statusFilter) label += ` (${statusFilter})`;

      labelEl.textContent = label;
      totalEl.textContent = 'Â¥' + totalAmount.toLocaleString();
      unpaidEl.textContent = 'Â¥' + unpaidAmount.toLocaleString();
      paidEl.textContent = 'Â¥' + paidAmount.toLocaleString();
      countEl.textContent = list.length;

      summaryArea.style.display = 'block';
    }


    function renderPaymentHistoryCards(list) {
      console.log('Rendering cards with list:', list);
      const con = document.getElementById('paymentListContainer');
      con.innerHTML = '';
      if (!list || list.length === 0) {
        console.log('List is empty or null');
        con.innerHTML = '<div style="text-align:center; color:#94a3b8;">å¯¾è±¡ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>';
        return;
      }

      // ç”»åƒä¸€æ‹¬å–å¾—ç”¨ãƒªã‚¹ãƒˆ
      const allFileIds = [];

      list.forEach((app, index) => {

        const card = document.createElement('div');
        card.className = 'admin-card';
        card.id = 'pay-card-' + app.appId;

        const isPaid = (app.paymentStatus === 'æ”¯æ‰•æ¸ˆ');
        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ¤å®šã®å …ç‰¢åŒ– (æ­£è¦è¡¨ç¾ã§åˆ¤å®š)
        const st = String(app.status || '');
        const isAppApproved = /^(APPROVED|FIXED|æ‰¿èªæ¸ˆã¿|æ”¯æ‰•æ¸ˆ)$/i.test(st);
        const isAppRejected = /^(REJECTED|å´ä¸‹)$/i.test(st);

        // æ”¯æ‰•çŠ¶æ…‹ãƒˆã‚°ãƒ«ãƒœã‚¿ãƒ³
        let payBtnHtml = '';
        if (!isAppRejected) {
          payBtnHtml = `<button onclick="togglePayment('${app.appId}', ${!isPaid})" style="font-size:0.9rem; padding:4px 12px; border-radius:12px; border:none; background:${isPaid ? '#cbd5e1' : '#10b981'}; color:${isPaid ? '#64748b' : 'white'}; font-weight:bold; cursor:pointer; margin-left:auto;">${isPaid ? 'âœ… æ”¯æ‰•æ¸ˆ' : 'ğŸ’° æœªæ‰•ã„'}</button>`;
        } else {
          payBtnHtml = `<span style="font-size:0.8rem; color:#ef4444; border:1px solid #ef4444; padding:2px 8px; border-radius:4px; margin-left:auto;">å´ä¸‹æ¸ˆã¿</span>`;
        }

        // è©³ç´°ãƒ»ä¿®æ­£ãƒœã‚¿ãƒ³
        const editBtnHtml = `<button onclick="openHistoryEdit('${app.appId}')" style="margin-top:8px; width:100%; padding:8px; border:1px solid #cbd5e1; background:white; color:#334155; border-radius:8px; font-size:0.9rem; cursor:pointer;">ğŸ” è©³ç´°ãƒ»ä¿®æ­£(å†åˆ¤å®š)</button>`;

        const head = `
          <div class="ac-header">
              <div>
                <div class="ac-user">${app.applicant} <span class="ac-dept">${app.dept || 'ä¸æ˜'}</span></div>
                <div style="font-size:0.8rem; color:#64748b;">${app.approvedAt}</div>
              </div>
              <div style="display:flex; flex-direction:column; align-items:flex-end;">
                 <div class="ac-total">Â¥${Number(app.totalAmount).toLocaleString()}</div>
                 <div style="margin-top:4px;">${payBtnHtml}</div>
              </div>
            </div>
          `;

        // ãƒœãƒ‡ã‚£ç”Ÿæˆ (AdminCardã¨ã»ã¼åŒã˜ã ãŒã€å…¥åŠ›ã¯disabledã«ã™ã‚‹)
        let bodyHtml = '<div class="ac-body" style="display:flex; flex-wrap:wrap; gap:8px;">';

        // è©³ç´°ãŒç„¡ã„å ´åˆã®ã‚¬ãƒ¼ãƒ‰
        const details = app.details || [];

        details.forEach(d => {
          // N+1å¯¾ç­–: ãƒ•ã‚¡ã‚¤ãƒ«IDã‚’åé›†
          if (d.hasImage && d.fileId) {
            allFileIds.push(d.fileId);
          }
          const imgId = `p-img-${d.detailId}`;

          bodyHtml += `
          <div class="detail-item">
            <div class="d-row">
              <div class="d-thumb-box" onclick="zoomImage('${imgId}')">
                <img id="${imgId}" class="d-thumb" style="width:100%; height:100%; object-fit:cover;" src="" data-file-id="${d.fileId || ''}">
                  ${(!d.hasImage) ? '<div style="font-size:0.6rem; color:#ccc; text-align:center; margin-top:16px;">No Image</div>' : ''}
              </div>
              <div class="d-inputs">
                <div class="input-group-compact span-full">
                  <label>åˆ©ç”¨æ—¥</label>
                  <div style="padding:4px; font-weight:bold;">${d.usageDate}</div>
                </div>
                <div class="input-group-compact span-full">
                  <label>åº—å</label>
                  <div style="padding:4px;">${d.vendor}</div>
                </div>
                <div class="input-group-compact">
                  <label>é‡‘é¡</label>
                  <div style="padding:4px;">Â¥${Number(d.amount).toLocaleString()}</div>
                </div>
                <div class="input-group-compact">
                  <label>ç¨ç‡</label>
                  <div style="padding:4px;">${d.taxRate}%</div>
                </div>
                <div class="input-group-compact">
                  <label>ç§‘ç›®</label>
                  <div style="padding:4px;">${d.subject}</div>
                </div>
                <div class="input-group-compact">
                  <label>ã‚¤ãƒ³ãƒœã‚¤ã‚¹</label>
                  <div style="padding:4px;">${d.invoiceReg}</div>
                </div>
                <div class="input-group-compact span-full">
                  <label>å‚™è€ƒ</label>
                  <div style="padding:4px; font-size:0.9rem; color:#666;">${d.purpose || '-'}</div>
                </div>
              </div>
            </div>
              </div>
          `;
        });
        bodyHtml += '</div>';

        // ãƒ•ãƒƒã‚¿ãƒ¼ (ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºç”¨)
        // å´ä¸‹
        const rjStyle = isAppRejected
          ? 'background:#fee2e2; color:#ef4444; border:1px solid #ef4444;'
          : 'background:#f1f5f9; color:#cbd5e1; border:1px solid #e2e8f0; opacity:0.5;';
        const rjIcon = isAppRejected ? 'âœ– å´ä¸‹' : 'å´ä¸‹';

        // å·®ã—æˆ»ã— (ä»Šå›ã¯æ”¯æ‰•ãƒªã‚¹ãƒˆã«ã¯å‡ºãªã„å‰æã ãŒã€æ ã ã‘ç”¨æ„)
        const rtStyle = 'background:#f1f5f9; color:#cbd5e1; border:1px solid #e2e8f0; opacity:0.5;';

        // æ‰¿èª
        const apStyle = isAppApproved
          ? 'background:#d1fae5; color:#10b981; border:1px solid #10b981;'
          : 'background:#f1f5f9; color:#cbd5e1; border:1px solid #e2e8f0; opacity:0.5;';
        const apIcon = isAppApproved ? 'âœ” æ‰¿èª' : 'æ‰¿èª';

        const foot = `
            <div class="ac-footer" style="cursor:default;">
              <div style="flex:1; text-align:center; padding:10px; border-radius:8px; font-weight:bold; ${rjStyle}">${rjIcon}</div>
              <div style="flex:1; text-align:center; padding:10px; border-radius:8px; font-weight:bold; ${rtStyle}">å·®ã—æˆ»ã—</div>
              <div style="flex:1; text-align:center; padding:10px; border-radius:8px; font-weight:bold; ${apStyle}">${apIcon}</div>
            </div>
          `;

        const fullHtml = head + bodyHtml + editBtnHtml + foot;
        card.innerHTML = fullHtml;
        con.appendChild(card);
      });

      // ç”»åƒå–å¾—
      if (allFileIds.length > 0) {
        google.script.run.withSuccessHandler(imgMap => {
          Object.keys(imgMap).forEach(fid => {
            const b64 = imgMap[fid];
            const targets = document.querySelectorAll(`img[data-file-id="${fid}"]`);
            targets.forEach(img => {
              if (b64) img.src = b64;
              else img.parentNode.innerHTML = '<div style="font-size:0.7rem; color:red; text-align:center; padding-top:20px;">Load Error</div>';
            });
          });
        }).withFailureHandler(e => { console.log('Image load fail', e); }).api_getImagesBatch(allFileIds);
      }
    }

    function togglePayment(appId, toPaid) {
      if (!confirm(toPaid ? 'ã€Œæ”¯æ‰•æ¸ˆã€ã«ã—ã¾ã™ã‹ï¼Ÿ' : 'ã€Œæœªæ‰•ã„ã€ã«æˆ»ã—ã¾ã™ã‹ï¼Ÿ')) return;
      const newStatus = toPaid ? 'æ”¯æ‰•æ¸ˆ' : 'æœªæ‰•ã„';

      showLoad('æ›´æ–°ä¸­...');
      google.script.run.withSuccessHandler(res => {
        hideLoad();
        showToast('æ›´æ–°ã—ã¾ã—ãŸ');
        // ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦åæ˜ 
        loadPaymentList();
      }).withFailureHandler(e => {
        hideLoad();
        showToast('æ›´æ–°å¤±æ•—: ' + e.message, 'error');
      }).api_updatePaymentStatus([appId], newStatus);
    }


    function showDetailModal(appId) {
      // å¤ã„é–¢æ•°ã ãŒå¿µã®ãŸã‚æ®‹ã™ã‹ã€ä¸è¦ãªã‚‰å‰Šé™¤ã€‚
      // ä»Šå›ã¯ã‚«ãƒ¼ãƒ‰è¡¨ç¤ºã«ã—ãŸã®ã§ä¸è¦ã ãŒã€å¾Œæ–¹äº’æ›ã§ã‚¨ãƒ©ãƒ¼ã«ãªã‚‰ãªã„ã‚ˆã†ç©ºã«ã—ã¦ãŠãã‹æ”¾ç½®ã€‚
    }

    // History Edit Logic
    function openHistoryEdit(appId) {
      const app = lastPaymentList.find(a => a.appId === appId);
      if (!app) {
        showToast('ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
        return;
      }

      const modal = document.getElementById('historyEditModal');
      const con = document.getElementById('historyEditContent');
      con.innerHTML = '';

      // createAdminCardElement ã‚’å‘¼ã³å‡ºã™éš›ã«ã€duplicateMap ã¯ç©ºã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æ¸¡ã™
      // æ”¯æ‰•ã„å±¥æ­´ã‹ã‚‰ã®ç·¨é›†ã§ã¯é‡è¤‡ãƒã‚§ãƒƒã‚¯ã¯ä¸è¦ãªãŸã‚
      const card = createAdminCardElement(app, {});
      con.appendChild(card);

      // Trigger Image Load
      const allFileIds = [];
      app.details.forEach(d => { if (d.hasImage && d.fileId) allFileIds.push(d.fileId); });
      if (allFileIds.length > 0) {
        google.script.run.withSuccessHandler(imgMap => {
          Object.keys(imgMap).forEach(fid => {
            const b64 = imgMap[fid];
            const targets = modal.querySelectorAll(`img[data-file-id="${fid}"]`);
            targets.forEach(img => { if (b64) img.src = b64; });
          });
        }).api_getImagesBatch(allFileIds);
      }

      modal.style.display = 'flex';
    }

    function closeHistoryEdit() {
      document.getElementById('historyEditModal').style.display = 'none';
      // Reload list to reflect changes
      loadPaymentList();
    }

  </script>
</body>

</html>