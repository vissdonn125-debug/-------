<script>
    /**
     * js_cart.html - User View, Camera, Cart, and History
     */

    // ========== Camera & OCR ==========
    let lastHistoryList = [];

    function openCamera() { document.getElementById('rFile').click(); }

    function handleFile(input) {
        if (!input.files[0]) return;
        const file = input.files[0];
        const id = Date.now();
        const isContinueMode = document.getElementById('continueMode').checked;

        const reader = new FileReader();
        reader.onload = e => {
            const dataUrl = e.target.result;

            // ç¶šããƒ¢ãƒ¼ãƒ‰ã®å ´åˆã€æœ€å¾Œã®æ˜ç´°ã«è¿½åŠ 
            if (isContinueMode && AppState.cartItems.length > 0) {
                const lastItem = AppState.cartItems[AppState.cartItems.length - 1];

                // ç”»åƒã‚’é…åˆ—ã§ä¿æŒï¼ˆåˆå›ã¯é…åˆ—åŒ–ï¼‰
                if (!Array.isArray(lastItem.imgData)) {
                    lastItem.imgData = [lastItem.imgData];
                }
                lastItem.imgData.push(dataUrl);

                lastItem.status = 'analyzing';
                renderCart();
                showToast('ç¶šãã‚’è§£æä¸­...');

                const base64 = dataUrl.split(',')[1];
                const mimeType = dataUrl.substring(dataUrl.indexOf(':') + 1, dataUrl.indexOf(';'));

                google.script.run.withSuccessHandler(res => {
                    lastItem.status = 'done';
                    lastItem.amount += res.ocr.amount; // é‡‘é¡ã‚’åŠ ç®—

                    // receiptUrlã‚‚é…åˆ—ã§ä¿æŒ
                    if (!Array.isArray(lastItem.receiptUrl)) {
                        lastItem.receiptUrl = [lastItem.receiptUrl];
                    }
                    lastItem.receiptUrl.push(res.receiptUrl);

                    renderCart();
                    showToast('ç¶šãã‚’è¿½åŠ : +Â¥' + res.ocr.amount.toLocaleString());
                    document.getElementById('continueMode').checked = false; // ãƒã‚§ãƒƒã‚¯ã‚’å¤–ã™
                }).withFailureHandler(e => {
                    lastItem.status = 'error';
                    renderCart();
                    showToast('è§£æå¤±æ•—: æ‰‹å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                }).uploadReceiptForOcr(base64, mimeType);

            } else {
                // é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ï¼šæ–°ã—ã„æ˜ç´°ã‚’ä½œæˆ
                const today = new Date().toISOString().split('T')[0];
                const item = { id: id, status: 'analyzing', amount: 0, vendor: '', subject: '', invoiceReg: 'ä¸æ˜', taxRate: 10, usageDate: today, purpose: '', imgData: dataUrl, receiptUrl: null };
                AppState.cartItems.push(item);
                renderCart();
                showToast('è§£æã‚’é–‹å§‹ã—ã¾ã—ãŸ');

                const base64 = dataUrl.split(',')[1];
                const mimeType = dataUrl.substring(dataUrl.indexOf(':') + 1, dataUrl.indexOf(';'));

                google.script.run.withSuccessHandler(res => {
                    const target = AppState.cartItems.find(i => i.id === id);
                    if (target) {
                        target.status = 'done';
                        target.amount = res.ocr.amount;
                        target.vendor = res.ocr.vendor;
                        target.subject = res.ocr.subject;
                        target.invoiceReg = res.ocr.invoiceReg || 'ä¸æ˜';
                        target.taxRate = res.ocr.taxRate || 10;
                        target.usageDate = res.ocr.date || today;
                        target.receiptUrl = res.receiptUrl;
                        renderCart();
                        showToast('è§£æå®Œäº†: ' + (target.vendor || 'åº—åä¸æ˜'));
                    }
                }).withFailureHandler(e => {
                    const target = AppState.cartItems.find(i => i.id === id);
                    if (target) {
                        target.status = 'error';
                        renderCart();
                        showToast('è§£æå¤±æ•—: æ‰‹å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                    }
                }).uploadReceiptForOcr(base64, mimeType);
            }

            setTimeout(() => { document.getElementById('rFile').value = ''; }, 500);
        };
        reader.readAsDataURL(file);
    }

    // ========== Cart Operations ==========
    function addManualItem() {
        const id = Date.now();
        const today = new Date().toISOString().split('T')[0];
        const item = {
            id: id,
            status: 'done',
            amount: 0,
            vendor: '',
            subject: '',
            invoiceReg: 'ä¸æ˜',
            taxRate: 10,
            usageDate: today,
            purpose: '',
            imgData: null,
            receiptUrl: null
        };
        AppState.cartItems.push(item);
        renderCart();
        openEdit(id);
        showToast('æ‰‹å…¥åŠ›æ˜ç´°ã‚’è¿½åŠ ã—ã¾ã—ãŸ');
    }

    function renderCart() {
        const list = document.getElementById('cartList');
        list.innerHTML = '';
        let total = 0;

        // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰è¡¨ç¤º
        if (AppState.editingAppId) {
            const warning = document.createElement('div');
            warning.innerHTML = `<div style="background:#fff7ed; color:#c2410c; padding:8px 12px; margin-bottom:12px; border-radius:8px; font-size:0.9rem; display:flex; justify-content:space-between; align-items:center;">
          <span>ğŸ“ éå»ã®ç”³è«‹ã‚’ç·¨é›†ä¸­</span>
          <button onclick="cancelEditMode()" style="background:none; border:1px solid #c2410c; border-radius:4px; color:#c2410c; padding:2px 8px; font-size:0.75rem;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>`;
            list.appendChild(warning);
        }

        if (AppState.cartItems.length === 0) {
            list.innerHTML += '<div class="cart-empty">ãƒ¬ã‚·ãƒ¼ãƒˆã‚’æ’®å½±ã—ã¦ãã ã•ã„</div>';
            document.getElementById('totalDisplay').innerText = '0';
            document.getElementById('submitBtn').disabled = true;
            const btnInner = document.getElementById('submitBtnText');
            if (btnInner) btnInner.innerText = 'ã¾ã¨ã‚ã¦ç”³è«‹';
            return;
        }

        AppState.cartItems.forEach((item) => {
            total += Number(item.amount || 0);
            const div = document.createElement('div');
            div.className = 'cart-item';
            div.onclick = (e) => {
                if (!e.target.closest('.cart-del-btn')) openEdit(item.id);
            };

            let overlay = item.status === 'analyzing' ? `<div class="analyzing-overlay"><div class="mini-spinner"></div></div>` : '';
            let amtClass = item.amount > 0 ? 'cart-amount' : 'cart-amount zero';
            let amtText = item.amount > 0 ? `Â¥${item.amount.toLocaleString()}` : 'Â¥ -';
            let statusText = item.status === 'analyzing' ? 'è§£æä¸­...' : (item.vendor || 'åº—åä¸æ˜');

            let imgHtml = '';
            const hasImgData = item.imgData && (Array.isArray(item.imgData) ? item.imgData.length > 0 : item.imgData);
            const hasUrl = item.receiptUrl && (Array.isArray(item.receiptUrl) ? item.receiptUrl.length > 0 : item.receiptUrl);

            if (hasImgData) {
                const imgSrc = Array.isArray(item.imgData) ? item.imgData[0] : item.imgData;
                const imgCount = Array.isArray(item.imgData) ? item.imgData.length : 1;
                const badge = imgCount > 1 ? `<div style="position:absolute; top:4px; right:4px; background:#3b82f6; color:white; border-radius:8px; padding:2px 8px; font-size:0.8rem; font-weight:700;">Ã—${imgCount}</div>` : '';
                imgHtml = `<img src="${imgSrc}" class="cart-thumb">${badge}`;
            } else if (hasUrl) {
                const urls = Array.isArray(item.receiptUrl) ? item.receiptUrl : [item.receiptUrl];
                const count = urls.length;
                let firstId = null;
                const m = urls[0].match(/id=([a-zA-Z0-9_-]+)/) || urls[0].match(/\/d\/([a-zA-Z0-9_-]+)/);
                if (m) firstId = m[1];

                if (firstId) {
                    const imgId = 'cart-img-' + item.id;
                    imgHtml = `<div class="cart-thumb" style="overflow:hidden; position:relative;">
              <img id="${imgId}" style="width:100%; height:100%; object-fit:cover;" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7">
              <div style="position:absolute; top:4px; right:4px; background:#64748b; color:white; border-radius:8px; padding:2px 8px; font-size:0.8rem;">ä¿å­˜æ¸ˆÃ—${count}</div>
            </div>`;
                    setTimeout(() => loadOneImage(firstId, imgId), 10);
                } else {
                    imgHtml = `<div class="cart-thumb" style="background:#f1f5f9; display:flex; align-items:center; justify-content:center; color:#64748b; font-size:0.8rem; font-weight:bold;"><span>ğŸ“· æ¸ˆÃ—${count}</span></div>`;
                }
            } else {
                imgHtml = `<div class="cart-thumb" style="background:#f1f5f9; display:flex; align-items:center; justify-content:center; color:#94a3b8; font-size:1.5rem;">âœï¸</div>`;
            }

            div.innerHTML = `
      <div class="cart-item-header">
        <div class="cart-thumb-box">
          ${imgHtml}
          ${overlay}
        </div>
        <div class="cart-item-content">
          <div class="cart-info">
            <div class="cart-meta">${item.subject ? `<span class="status-badge">${item.subject}</span>` : ''}</div>
            <div class="cart-vendor">${statusText}</div>
          </div>
        </div>
      </div>
      <div class="cart-item-actions">
        <div class="${amtClass}">${amtText}</div>
        <button class="cart-del-btn" onclick="event.stopPropagation(); delCart(${item.id})">
          <span>ğŸ—‘ï¸</span> å‰Šé™¤
        </button>
      </div>
    `;
            list.appendChild(div);
        });
        document.getElementById('totalDisplay').textContent = total.toLocaleString();
        document.getElementById('submitBtn').disabled = false;

        const btnInner = document.getElementById('submitBtnText');
        if (btnInner) {
            btnInner.innerText = AppState.editingAppId ? 'æ›´æ–°ã—ã¦å†ç”³è«‹' : 'ã¾ã¨ã‚ã¦ç”³è«‹';
        }
    }

    function delCart(id) {
        showConfirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ', () => {
            AppState.cartItems = AppState.cartItems.filter(i => i.id !== id);
            renderCart();
        });
    }

    function cancelEditMode() {
        showConfirm('ç·¨é›†å†…å®¹ã‚’ç ´æ£„ã—ã¦æ–°è¦ä½œæˆã«æˆ»ã‚Šã¾ã™ã‹ï¼Ÿ', () => {
            AppState.editingAppId = null;
            AppState.cartItems = [];
            renderCart();
        });
    }

    // ========== Edit Modal (Cart Item) ==========
    function openEdit(id) {
        const item = AppState.cartItems.find(i => i.id === id);
        if (!item) return;
        AppState.editingId = id;

        const imgBox = document.querySelector('.edit-img-box');
        imgBox.innerHTML = '';

        const hasImg = item.imgData && (Array.isArray(item.imgData) ? item.imgData.length > 0 : true);

        if (hasImg) {
            if (Array.isArray(item.imgData)) {
                item.imgData.forEach((img, idx) => {
                    const imgEl = document.createElement('img');
                    imgEl.src = img;
                    imgEl.className = 'edit-img';
                    imgEl.style.marginBottom = idx < item.imgData.length - 1 ? '12px' : '0';
                    imgEl.onclick = function () { zoomImageSrc(this.src); };
                    imgBox.appendChild(imgEl);
                });
            } else {
                const imgEl = document.createElement('img');
                imgEl.src = item.imgData;
                imgEl.className = 'edit-img';
                imgEl.onclick = function () { zoomImageSrc(this.src); };
                imgBox.appendChild(imgEl);
            }
            imgBox.style.display = 'block';
        } else if (item.receiptUrl) {
            imgBox.innerHTML = '';
            let urls = [];
            if (Array.isArray(item.receiptUrl)) urls = item.receiptUrl;
            else if (typeof item.receiptUrl === 'string') urls = item.receiptUrl.split(',').filter(u => u.trim());

            if (urls.length > 0) {
                urls.forEach((u, i) => {
                    const btn = document.createElement('div');
                    btn.innerHTML = `<span>ğŸ“· ä¿å­˜æ¸ˆã¿ç”»åƒ ${i + 1} ã‚’è¦‹ã‚‹</span>`;
                    btn.onclick = () => zoomImageSrc(u.trim());
                    btn.style.cssText = 'padding:12px 20px; background:white; margin:6px; border-radius:12px; cursor:pointer; font-weight:bold; color:#3b82f6; display:flex; align-items:center; justify-content:center; gap:8px; width:80%; box-shadow:0 2px 5px rgba(0,0,0,0.1); transition:transform 0.1s;';
                    btn.onmousedown = () => btn.style.transform = 'scale(0.96)';
                    btn.onmouseup = () => btn.style.transform = 'scale(1)';
                    imgBox.appendChild(btn);
                });
                imgBox.style.display = 'flex';
                imgBox.style.flexDirection = 'column';
            } else {
                imgBox.style.display = 'none';
            }
        } else {
            imgBox.style.display = 'none';
        }

        document.getElementById('eDate').value = item.usageDate || new Date().toISOString().split('T')[0];
        document.getElementById('eAmt').value = item.amount || '';
        document.getElementById('eTax').value = item.taxRate || 10;
        document.getElementById('eVen').value = item.vendor || '';
        document.getElementById('eSub').value = item.subject || '';
        document.getElementById('ePurpose').value = item.purpose || '';
        document.getElementById('editModal').style.display = 'flex';
    }

    function saveEdit() {
        const item = AppState.cartItems.find(i => i.id === AppState.editingId);
        if (item) {
            item.usageDate = document.getElementById('eDate').value;
            item.amount = Number(document.getElementById('eAmt').value);
            item.taxRate = Number(document.getElementById('eTax').value);
            item.vendor = document.getElementById('eVen').value;
            item.subject = document.getElementById('eSub').value;
            item.purpose = document.getElementById('ePurpose').value;
            if (item.status !== 'analyzing') item.status = 'done';
        }
        renderCart();
        document.getElementById('editModal').style.display = 'none';
    }

    function updateTaxRateBySubject() {
        const subjectName = document.getElementById('eSub').value;
        const subjectData = AppState.subjectMasterWithTax.find(s => s.name === subjectName);
        if (subjectData) {
            document.getElementById('eTax').value = subjectData.taxRate;
        }
    }
    function closeEdit() { document.getElementById('editModal').style.display = 'none'; }

    // ========== Submission ==========
    function submitCart() {
        if (AppState.cartItems.length === 0) return;
        const invalid = AppState.cartItems.some(i => !i.amount || i.amount <= 0);
        if (invalid) return showToast('é‡‘é¡ãŒæœªå…¥åŠ›ã®æ˜ç´°ãŒã‚ã‚Šã¾ã™ï¼', 'error');
        const analyzing = AppState.cartItems.some(i => i.status === 'analyzing');
        if (analyzing) return showToast('è§£æä¸­ã®æ˜ç´°ãŒã‚ã‚Šã¾ã™', 'error');

        const isUpdate = !!AppState.editingAppId;
        const msg = isUpdate
            ? `ä¿®æ­£å†…å®¹ã§æ›´æ–°ï¼ˆå†ç”³è«‹ï¼‰ã—ã¾ã™ã‹ï¼Ÿ\nåˆè¨ˆ Â¥${document.getElementById('totalDisplay').innerText}`
            : `åˆè¨ˆ Â¥${document.getElementById('totalDisplay').innerText} ã§ç”³è«‹ã—ã¾ã™ã‹ï¼Ÿ`;

        showConfirm(msg, () => {
            const applicantId = document.getElementById('applicantSelector').value;
            const data = { applicantId: applicantId, items: AppState.cartItems };

            showLoad(isUpdate ? 'æ›´æ–°ä¸­...' : 'ç”³è«‹é€ä¿¡ä¸­...');

            const successHandler = (res) => {
                hideLoad();
                showToast(isUpdate ? 'æ›´æ–°ã—ã¾ã—ãŸï¼' : 'ç”³è«‹ãŒå®Œäº†ã—ã¾ã—ãŸï¼');
                AppState.cartItems = [];
                AppState.editingAppId = null;
                renderCart();
            };
            const failureHandler = (e) => {
                hideLoad();
                showToast('é€ä¿¡å¤±æ•—: ' + e.message, 'error');
            };

            if (isUpdate) {
                google.script.run.withSuccessHandler(successHandler).withFailureHandler(failureHandler).api_updateApplication(AppState.editingAppId, data);
            } else {
                google.script.run.withSuccessHandler(successHandler).withFailureHandler(failureHandler).api_submitExpense(data);
            }
        });
    }

    // ========== History ==========
    function loadHistory() {
        const picker = document.getElementById('historyMonthPicker');
        if (picker.options.length <= 1) {
            const now = new Date();
            for (let i = 0; i < 12; i++) {
                const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
                const val = d.getFullYear() + '-' + ('0' + (d.getMonth() + 1)).slice(-2);
                const txt = d.getFullYear() + 'å¹´' + (d.getMonth() + 1) + 'æœˆ';
                const op = document.createElement('option');
                op.value = val; op.text = txt;
                if (i === 0) op.selected = true;
                picker.appendChild(op);
            }
        }

        const targetMonth = picker.value || '';
        const listEl = document.getElementById('historyInnerList');
        if (listEl) listEl.innerHTML = '<div style="text-align:center; color:#64748b; margin-top:40px;">èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</div>';

        // Reset filter
        const brFilter = document.getElementById('historyBranchFilter');
        if (brFilter) brFilter.value = '';

        google.script.run.withSuccessHandler(list => {
            lastHistoryList = list || [];
            renderHistoryCards(lastHistoryList);
        }).withFailureHandler(e => {
            listEl.innerHTML = '<div style="color:red; text-align:center;">èª­ã¿è¾¼ã¿å¤±æ•—</div>';
            showToast('ã‚¨ãƒ©ãƒ¼: ' + e.message, 'error');
        }).api_getMyHistory(targetMonth);
    }

    function renderHistoryCards(list) {
        const listEl = document.getElementById('historyInnerList');
        if (!listEl) return;

        // Ensure filters are applied
        const brFilter = document.getElementById('historyBranchFilter');
        const selectedBranch = brFilter ? brFilter.value : '';

        let filtered = list;
        if (selectedBranch) {
            filtered = list.filter(item => item.dept === selectedBranch);
        }

        if (!filtered || filtered.length === 0) {
            listEl.innerHTML = '<div style="text-align:center; color:#64748b; margin-top:40px;">å±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
            return;
        }

        listEl.innerHTML = filtered.map(item => {
            let thumbHtml = '';
            if (item.firstImageId) {
                const imgId = 'h-img-' + item.applicationId;
                const thumbUrl = 'https://drive.google.com/thumbnail?id=' + item.firstImageId + '&sz=w200';
                thumbHtml = `<div style="width:50px; height:50px; border-radius:6px; overflow:hidden; background:#f1f5f9; margin-right:12px; flex-shrink:0; cursor:pointer;" onclick="zoomImage('${imgId}')">
              <img id="${imgId}" style="width:100%; height:100%; object-fit:cover;" 
                   data-file-id="${item.firstImageId}" 
                   src="${thumbUrl}" 
                   loading="lazy"
                   onerror="this.onerror=null; this.style.display='none'; this.parentNode.innerHTML='<span style=\'font-size:0.8rem; color:#94a3b8;\'>ğŸ“·</span>';">
           </div>`;
            } else {
                thumbHtml = `<div style="width:50px; height:50px; border-radius:6px; background:#f1f5f9; display:flex; align-items:center; justify-content:center; color:#cbd5e1; margin-right:12px; flex-shrink:0;">
              <span>ğŸ“·</span>
           </div>`;
            }

            const canEdit = (item.statusLabel !== APP_CONST.STATUS.APPROVED && item.statusLabel !== APP_CONST.STATUS.FIXED);
            const editBtn = canEdit
                ? `<button onclick="loadApplicationForEdit('${item.applicationId}')" style="margin-top:8px; padding:6px 12px; border:1px solid #cbd5e1; border-radius:6px; background:white; font-size:0.8rem; color:#334155; cursor:pointer;">âœ ç·¨é›†ãƒ»å†ç”³è«‹</button>`
                : '';

            return `
          <div class="history-item">
            <div style="display:flex; align-items:center; flex:1;">
               ${thumbHtml}
               <div style="min-width:0;">
                 <div style="font-size:0.85rem; color:#64748b; margin-bottom:2px;">${item.displayDate}</div>
                 <div style="font-weight:bold; font-size:1rem; color:#1e293b; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${item.statusLabel}</div>
               </div>
            </div>
            <div style="text-align:right;">
               <div style="font-weight:900; font-size:1.1rem; color:#1e293b;">Â¥${(item.totalAmount || 0).toLocaleString()}</div>
               ${editBtn}
            </div>
          </div>
      `;
        }).join('');
    }

    function loadApplicationForEdit(appId) {
        const proceed = () => {
            showLoad('ç”³è«‹ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­...');
            google.script.run.withSuccessHandler(res => {
                hideLoad();
                AppState.editingAppId = appId;
                AppState.cartItems = res.items;
                renderCart();
                switchView('userView');
                showToast('ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã«ãªã‚Šã¾ã—ãŸ');
            }).withFailureHandler(e => {
                hideLoad();
                showToast('å–å¾—ã‚¨ãƒ©ãƒ¼: ' + e.message, 'error');
            }).api_getApplication(appId);
        };

        if (AppState.cartItems.length > 0) {
            showConfirm('ç¾åœ¨å…¥åŠ›ä¸­ã®å†…å®¹ã¯ç ´æ£„ã•ã‚Œã¾ã™ãŒã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ', proceed);
        } else {
            proceed();
        }
    }
</script>